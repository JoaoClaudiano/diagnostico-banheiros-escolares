<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Lista de escolas -->
<script src="./mapa/escolas.js"></script>

<style>
/* ===== GERAL ===== */
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}

/* ===== LOGO ===== */
.logo-area {
  text-align:center;
  margin:40px 0 10px;
}

.logo-area img {
  height:90px;
}

/* ===== CARD PRINCIPAL ===== */
.card {
  background:#fff;
  max-width:900px;
  margin:20px auto 40px;
  padding:30px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

h2 {
  text-align:center;
  margin-bottom:25px;
}

/* ===== CAMPOS ===== */
label {
  display:block;
  margin-top:18px;
  font-weight:bold;
}

input[type="text"],
input[type="file"] {
  width:100%;
  margin-top:6px;
  padding:10px;
}

/* ===== GRID DE CARDS ===== */
.cards {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:18px;
  margin-top:25px;
}

.card-check {
  border:1px solid #ddd;
  border-radius:8px;
  padding:16px;
}

.card-check h4 {
  margin:0 0 10px;
  font-size:16px;
}

/* ===== CHECKS ===== */
.check {
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:8px;
}

.check input {
  transform: scale(1.2);
}

/* ===== BOT√ÉO ===== */
button {
  margin-top:35px;
  width:100%;
  padding:16px;
  font-size:17px;
  background:#1f4fd8;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

/* ===== RESULTADO ===== */
.resultado {
  margin-top:25px;
  padding:18px;
  border-radius:8px;
  font-weight:bold;
}

.ok { background:#d4edda; }
.alerta { background:#fff3cd; }
.critico { background:#f8d7da; }
</style>
</head>

<body>

<!-- LOGO CENTRAL -->
<div class="logo-area">
  <img src="./assets/logo-checkinfra.png" alt="CheckInfra">
</div>

<!-- CARD PRINCIPAL -->
<div class="card">
<h2>Avalia√ß√£o Sanit√°ria dos Banheiros</h2>

<label>Escola</label>
<input id="escola" list="listaEscolas" placeholder="Digite ou selecione">
<datalist id="listaEscolas"></datalist>

<label>Avaliador respons√°vel</label>
<input id="avaliador" type="text">

<label>Fotos do banheiro (opcional)</label>
<input id="fotos" type="file" accept="image/*" multiple>

<!-- CHECKLIST EM CARDS -->
<div class="cards">

  <div class="card-check">
    <h4>üå´Ô∏è Ambiente</h4>
    <div class="check"><input type="checkbox" data-peso="4"> Mofo / bolor</div>
    <div class="check"><input type="checkbox" data-peso="2"> Mau cheiro</div>
    <div class="check"><input type="checkbox" data-peso="1"> Ilumina√ß√£o ruim</div>
  </div>

  <div class="card-check">
    <h4>üß± Estrutura</h4>
    <div class="check"><input type="checkbox" data-peso="3"> Infiltra√ß√£o</div>
    <div class="check"><input type="checkbox" data-peso="2"> Piso danificado</div>
  </div>

  <div class="card-check">
    <h4>üíß Hidrossanit√°rio</h4>
    <div class="check"><input type="checkbox" data-peso="2"> Vazamentos</div>
    <div class="check"><input type="checkbox" data-peso="3"> Sanit√°rio ou torneira quebrados</div>
  </div>

</div>

<button onclick="gerarDiagnostico()">Gerar diagn√≥stico e PDF</button>

<div id="resultado" class="resultado"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIqrAdgd7pLsW0kYAnrrHQ-WrCsnbR4Eh9BpkamYbrKwCOFP5fH6N52HFw2nOz2t2G/exec";

/* Lista de escolas */
const lista = document.getElementById("listaEscolas");
escolas.forEach(e => {
  const opt = document.createElement("option");
  opt.value = e.nome;
  lista.appendChild(opt);
});

function gerarDiagnostico() {
  const escola = document.getElementById("escola").value;
  const avaliador = document.getElementById("avaliador").value;
  const arquivos = document.getElementById("fotos").files;

  if (!escola || !avaliador) {
    alert("Preencha a escola e o avaliador");
    return;
  }

  let score = 0;
  let problemas = [];

  document.querySelectorAll("input[type=checkbox]").forEach(cb => {
    if (cb.checked) {
      score += parseInt(cb.dataset.peso);
      problemas.push(cb.parentElement.textContent.trim());
    }
  });

  let status = "Condi√ß√£o adequada";
  let classe = "ok";

  if (score >= 9) { status = "Condi√ß√£o cr√≠tica"; classe = "critico"; }
  else if (score >= 4) { status = "Situa√ß√£o de alerta"; classe = "alerta"; }

  const r = document.getElementById("resultado");
  r.className = "resultado " + classe;
  r.innerHTML = `
    Escola: ${escola}<br>
    Avaliador: ${avaliador}<br>
    Pontua√ß√£o t√©cnica: ${score}<br>
    Status: ${status}
  `;

  fetch(SCRIPT_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      escola, avaliador, pontuacao:score, status, problemas:problemas.join("; ")
    })
  });

  gerarPDF(escola, avaliador, score, status, arquivos);
}

function gerarPDF(escola, avaliador, score, status, arquivos) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 20;

  pdf.text("Relat√≥rio Sanit√°rio ‚Äì CheckInfra", 20, y); y+=15;
  pdf.text(`Escola: ${escola}`, 20, y); y+=10;
  pdf.text(`Avaliador: ${avaliador}`, 20, y); y+=10;
  pdf.text(`Pontua√ß√£o: ${score}`, 20, y); y+=10;
  pdf.text(`Status: ${status}`, 20, y); y+=15;

  if (arquivos.length === 0) {
    pdf.save(`avaliacao_${escola}.pdf`);
    return;
  }

  Array.from(arquivos).forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = e => {
      pdf.addImage(e.target.result, "JPEG", 20, y, 160, 90);
      y += 100;
      if (i === arquivos.length - 1) {
        pdf.save(`avaliacao_${escola}.pdf`);
      }
    };
    reader.readAsDataURL(file);
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Avalia칞칚o Sanit치ria Escolar</title>

<style>
body { font-family: Arial; padding: 20px; }
label { display: block; margin-top: 15px; }
button { margin-top: 20px; padding: 10px 15px; }
.status { margin-top: 20px; padding: 15px; border-radius: 6px; display: flex; align-items: center; }
.verde { background: #e0f7e9; }
.amarelo { background: #fff7cc; }
.vermelho { background: #ffe0e0; }
.bola { width: 15px; height: 15px; border-radius: 50%; margin-right: 10px; }
.verde .bola { background: green; }
.amarelo .bola { background: orange; }
.vermelho .bola { background: red; }
</style>
</head>

<body>

<h2>Avalia칞칚o Sanit치ria de Banheiros Escolares</h2>

<label>Escola:</label>
<select id="escola">
  <option value="">Selecione a escola</option>
</select>

<label>Respons치vel pela avalia칞칚o:</label>
<input id="responsavel" type="text">

<label><input type="checkbox" id="piso"> Piso quebrado</label>
<label><input type="checkbox" id="mofo"> Mofo ou infiltra칞칚o</label>
<label><input type="checkbox" id="sanitario"> Sanit치rio ou torneira quebrados</label>

<button onclick="avaliar()">Gerar diagn칩stico</button>

<div id="resultado"></div>

<!-- 游댳 CARREGA ESCOLAS DO KML -->
<script src="mapa/escolas.js"></script>

<!-- 游댳 SCRIPT PRINCIPAL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let dadosUltimaAvaliacao = null;

document.addEventListener("escolasCarregadas", () => {
  const select = document.getElementById("escola");
  escolas.forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.nome;
    opt.textContent = e.nome;
    select.appendChild(opt);
  });
});

function avaliar(){
  const escola = document.getElementById("escola").value;
  const responsavel = document.getElementById("responsavel").value;
  const data = new Date().toLocaleDateString();

  let pontos = 0;
  if(document.getElementById("piso").checked) pontos += 2;
  if(document.getElementById("mofo").checked) pontos += 3;
  if(document.getElementById("sanitario").checked) pontos += 2;

  let status, classe;
  if(pontos >= 5){ status = "Cr칤tico"; classe = "vermelho"; }
  else if(pontos >= 2){ status = "Alerta"; classe = "amarelo"; }
  else { status = "Adequado"; classe = "verde"; }

  dadosUltimaAvaliacao = { escola, responsavel, data, pontos, status };

  document.getElementById("resultado").innerHTML = `
    <div class="status ${classe}">
      <div class="bola"></div>
      <div>
        <strong>Status: ${status}</strong><br>
        Pontua칞칚o t칠cnica: ${pontos}
      </div>
    </div>
    <button onclick="gerarPDF()">Gerar PDF</button>
  `;

  salvarAvaliacaoSheets(escola, status, pontos, data);
}

function gerarPDF(){
  const { jsPDF } = window.jspdf;
  const d = dadosUltimaAvaliacao;
  const doc = new jsPDF();

  doc.text("Relat칩rio de Avalia칞칚o Sanit치ria Escolar", 20, 20);
  doc.text(Escola: ${d.escola}, 20, 40);
  doc.text(Respons치vel: ${d.responsavel}, 20, 50);
  doc.text(Data: ${d.data}, 20, 60);
  doc.text(Status: ${d.status}, 20, 80);
  doc.text(Pontua칞칚o: ${d.pontos}, 20, 90);

  doc.save("avaliacao_sanitaria.pdf");
}

function salvarAvaliacaoSheets(escola, status, pontos, data){
  fetch("COLE_AQUI_A_URL_DO_APPS_SCRIPT", {
    method: "POST",
    body: JSON.stringify({
      escola,
      status,
      pontos,
      data,
      responsavel: document.getElementById("responsavel").value
    })
  });
}
</script>

</body>
</html>

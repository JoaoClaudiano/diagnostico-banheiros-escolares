<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;}
.header{background:#1f4fd8;color:#fff;padding:16px;text-align:center;}
.container{max-width:900px;margin:30px auto;padding:0 16px;}
h1{text-align:center;margin-bottom:24px;}
.card{background:#fff;border-radius:14px;padding:20px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.08);}
label{font-weight:bold;margin-bottom:6px;display:block;}
select,input[type="text"],input[type="file"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:14px;}
.categoria{margin-bottom:26px;}
.categoria h3{color:#1f4fd8;margin-bottom:12px;}
.checklist{display:flex;flex-direction:column;gap:12px;}
.check-card{border:2px solid #e0e0e0;border-radius:12px;padding:16px;cursor:pointer;transition:.2s;background:#fafafa;font-weight:500;}
.check-card input{display:none;}
.check-card:hover{border-color:#1f4fd8;background:#f0f5ff;}
.check-card:has(input:checked){border-color:#1f4fd8;background:#eaf0ff;font-weight:bold;}
.preview{display:flex;gap:10px;flex-wrap:wrap;}
.preview img{width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #ccc;}
button{width:100%;padding:16px;background:#1f4fd8;color:#fff;font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;}
button:hover{background:#163ca6;}
.resultado{margin-top:20px;padding:20px;border-radius:12px;display:none;font-weight:bold;}
.ok{background:#e8f7ee;color:#1e7e34;}
.alerta{background:#fff3cd;color:#856404;}
.critico{background:#f8d7da;color:#721c24;}
</style>
</head>

<body>

<div class="header"><strong>CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria</strong></div>

<div class="container">
<h1>Avalia√ß√£o Sanit√°ria Escolar</h1>

<div class="card">
<label>Escola</label>
<select id="escola"><option>Carregando escolas‚Ä¶</option></select>

<label>Avaliador</label>
<input type="text" id="avaliador" placeholder="Nome do avaliador">
</div>

<div class="card">

<div class="categoria">
<h3>üèóÔ∏è Estrutura</h3>
<div class="checklist">
<label class="check-card"><input type="checkbox" data-peso="3">Mofo ou umidade excessiva</label>
<label class="check-card"><input type="checkbox" data-peso="2">Piso quebrado ou escorregadio</label>
<label class="check-card"><input type="checkbox" data-peso="2">Infiltra√ß√µes vis√≠veis</label>
</div>
</div>

<div class="categoria">
<h3>üßπ Higiene</h3>
<div class="checklist">
<label class="check-card"><input type="checkbox" data-peso="2">Limpeza inadequada</label>
<label class="check-card"><input type="checkbox" data-peso="2">Mau cheiro persistente</label>
</div>
</div>

<div class="categoria">
<h3>üí° Conforto</h3>
<div class="checklist">
<label class="check-card"><input type="checkbox" data-peso="1">Ilumina√ß√£o insuficiente</label>
<label class="check-card"><input type="checkbox" data-peso="1">Ventila√ß√£o inadequada</label>
</div>
</div>

</div>

<div class="card">
<h3>üì∑ Registro Fotogr√°fico</h3>
<input type="file" id="fotos" accept="image/*" multiple>
<div class="preview" id="preview"></div>
</div>

<button onclick="gerarDiagnostico()">Gerar Diagn√≥stico</button>
<div id="resultado" class="resultado"></div>
</div>

<script src="./mapa/escolas.js"></script>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt2ba43-ZwETWri7JoEFX9InL75iCtlqn796gQBjCRr4MGm0KgT_Tff8_MxiB4CZ2zCw/exec";
let imagensBase64 = [];

/* escolas */
document.addEventListener("DOMContentLoaded",()=>{
  const s=document.getElementById("escola");
  s.innerHTML='<option value="">Selecione a escola</option>';
  escolas.forEach(e=>{
    const o=document.createElement("option");
    o.value=e.nome;
    o.textContent=e.nome;
    s.appendChild(o);
  });
});

/* fotos */
document.getElementById("fotos").addEventListener("change",e=>{
  imagensBase64=[];
  const p=document.getElementById("preview");
  p.innerHTML="";
  [...e.target.files].forEach(file=>{
    const r=new FileReader();
    r.onload=ev=>{
      imagensBase64.push(ev.target.result);
      const img=document.createElement("img");
      img.src=ev.target.result;
      p.appendChild(img);
    };
    r.readAsDataURL(file);
  });
});

/* pdf */
function gerarPDF(escola,avaliador,score,status,problemas){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=20;

  pdf.setFontSize(16);
  pdf.text("CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria",10,y);y+=12;
  pdf.setFontSize(12);
  pdf.text(`Escola: ${escola}`,10,y);y+=8;
  pdf.text(`Avaliador: ${avaliador}`,10,y);y+=8;
  pdf.text(`Pontua√ß√£o: ${score}`,10,y);y+=8;
  pdf.text(`Status: ${status}`,10,y);y+=10;
  pdf.text("Itens avaliados:",10,y);y+=8;

  problemas.forEach(p=>{pdf.text("- "+p,12,y);y+=7;});
  imagensBase64.forEach(img=>{
    if(y>230){pdf.addPage();y=20;}
    pdf.addImage(img,"JPEG",10,y,60,45);
    y+=50;
  });

  pdf.save(`avaliacao_${escola.replaceAll(" ","_")}.pdf`);
}

/* diagn√≥stico */
function gerarDiagnostico(){
  const escola=document.getElementById("escola").value;
  const avaliador=document.getElementById("avaliador").value;
  if(!escola||!avaliador){alert("Preencha todos os campos");return;}

  let score=0,problemas=[];
  document.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    if(cb.checked){
      score+=Number(cb.dataset.peso);
      problemas.push(cb.parentElement.textContent.trim());
    }
  });

  let status="Condi√ß√£o adequada",classe="ok";
  if(score>=9){status="Condi√ß√£o cr√≠tica";classe="critico";}
  else if(score>=4){status="Situa√ß√£o de alerta";classe="alerta";}

  const r=document.getElementById("resultado");
  r.className="resultado "+classe;
  r.style.display="block";
  r.innerHTML=`Avalia√ß√£o registrada.<br>Status: ${status}<br>Redirecionando‚Ä¶`;

  gerarPDF(escola,avaliador,score,status,problemas);

  const escolaObj = escolas.find(x => x.nome === escola);

  /* ‚úÖ POST CORRETO (SEM no-cors) */
  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      escola: escola,
      avaliador: avaliador,
      pontuacao: score,
      status: status,
      problemas: problemas.join("; "),
      lat: escolaObj ? escolaObj.lat : "",
      lng: escolaObj ? escolaObj.lng : ""
    })
  })
  .then(r => r.json())
  .then(resp => console.log("Sheets:", resp))
  .catch(err => console.error("Erro POST:", err));

  setTimeout(()=>location.href="./index.html",3000);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Avaliação Sanitária Escolar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}

h2,h3{ margin-top:0; }

section{
  background:#fff;
  padding:20px;
  border-radius:10px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

label{
  font-weight:bold;
  display:block;
  margin-top:10px;
}

input, select{
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:6px;
  border:1px solid #ccc;
}

.checklist-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 0;
  border-bottom:1px solid #eee;
}

.checklist-item:last-child{ border-bottom:none; }

button{
  width:100%;
  padding:15px;
  background:#1f3a5f;
  color:white;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}

.status{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:20px;
  font-size:18px;
}

.bola{
  width:18px;
  height:18px;
  border-radius:50%;
}

.adequado .bola{ background:green; }
.alerta .bola{ background:orange; }
.critico .bola{ background:red; }
</style>
</head>

<body>

<h2>Diagnóstico Sanitário de Banheiros Escolares</h2>

<section>
<h3>Identificação da Avaliação</h3>

<label>Escola</label>
<select id="escola">
  <option value="">Selecione a escola</option>
  
    
</select>

<label>Responsável pela avaliação</label>
<input type="text" id="responsavel" placeholder="Nome do gestor ou diretor">

<label>Data</label>
<input type="date" id="data">
</section>

<section>
<h3>Checklist Sanitário (Engenharia Diagnóstica)</h3>

<div class="checklist-item">
  <input type="checkbox" data-peso="4"> Presença de mofo ou bolor visível
</div>

<div class="checklist-item">
  <input type="checkbox" data-peso="3"> Piso quebrado, solto ou escorregadio
</div>

<div class="checklist-item">
  <input type="checkbox" data-peso="3"> Vazamentos aparentes
</div>

<div class="checklist-item">
  <input type="checkbox" data-peso="2"> Sanitário ou mictório danificado
</div>

<div class="checklist-item">
  <input type="checkbox" data-peso="2"> Falta de ventilação adequada
</div>

<div class="checklist-item">
  <input type="checkbox" data-peso="2"> Iluminação insuficiente
</div>

<div class="checklist-item">
  <input type="checkbox" data-peso="1"> Ausência de sabonete, papel ou lixeira
</div>

</section>

<section>
<h3>Registro Fotográfico</h3>
<input type="file" id="fotos" multiple accept="image/*">
</section>

<button onclick="avaliar()">Gerar Diagnóstico</button>

<div id="resultado"></div>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>
<script>
fetch("mapa/escolas.kml")
  .then(res => res.text())
  .then(kmlText => {
    const parser = new DOMParser();
    const xml = parser.parseFromString(kmlText, "text/xml");
    const placemarks = xml.getElementsByTagName("Placemark");

    const select = document.getElementById("escola");
    const nomes = new Set();

    for (let p of placemarks) {
      const desc = p.getElementsByTagName("description")[0];
      if (!desc) continue;

      const html = desc.textContent;
      const match = html.match(/Nome<\/span>.*?atr-value">([^<]+)</);

      if (match) {
        nomes.add(match[1].trim());
      }
    }

    [...nomes].sort().forEach(nome => {
      const opt = document.createElement("option");
      opt.value = nome;
      opt.textContent = nome;
      select.appendChild(opt);
    });
  });
</script>
  
<script>
/* ===============================
   VARIÁVEL GLOBAL SEGURA
================================ */
let dadosUltimaAvaliacao = null;

/* ===============================
   PARÂMETROS TÉCNICOS
================================ */
const LIMIAR_ALERTA = 4;
const LIMIAR_CRITICO = 8;

/* ===============================
   FUNÇÃO PRINCIPAL
================================ */
function avaliar(){

  const escola = document.getElementById("escola").value;
  const responsavel = document.getElementById("responsavel").value;
  const data = document.getElementById("data").value;

  if(!escola){ alert("Selecione a escola."); return; }
  if(!responsavel){ alert("Informe o responsável."); return; }
  if(!data){ alert("Informe a data."); return; }

  let pontos = 0;
  document
    .querySelectorAll(".checklist-item input:checked")
    .forEach(i => pontos += Number(i.dataset.peso));

  if(document.getElementById("fotos").files.length > 0){
    pontos += 2;
  }

  let status = "adequado";
  let classe = "adequado";
  let textoStatus = "Condição adequada";

  if(pontos >= LIMIAR_CRITICO){
    status = "critico";
    classe = "critico";
    textoStatus = "Condição crítica – intervenção urgente";
  }
  else if(pontos >= LIMIAR_ALERTA){
    status = "alerta";
    classe = "alerta";
    textoStatus = "Condição de alerta – manutenção necessária";
  }

  dadosUltimaAvaliacao = {
    escola,
    responsavel,
    data,
    textoStatus,
    pontos
  };

  document.getElementById("resultado").innerHTML = `
    <div class="status ${classe}">
      <div class="bola"></div>
      <div>
        <strong>${textoStatus}</strong><br>
        Pontuação técnica: ${pontos}
      </div>
    </div>

    <button style="margin-top:15px" onclick="gerarPDF()">
      Gerar Relatório em PDF
    </button>
  `;

  salvarAvaliacaoMapa(escola, status, pontos, data);
}

/* ===============================
   SALVAR PARA O MAPA
================================ */
function salvarAvaliacaoMapa(escola, status, pontos, data){
  let registros = JSON.parse(localStorage.getItem("avaliacoes")) || [];
  registros = registros.filter(r => r.escola !== escola);
  registros.push({ escola, status, pontos, data });
  localStorage.setItem("avaliacoes", JSON.stringify(registros));
}

/* ===============================
   GERAR PDF (SEM BUG)
================================ */
function gerarPDF(){

  if(!dadosUltimaAvaliacao){
    alert("Nenhuma avaliação disponível.");
    return;
  }

  const { escola, responsavel, data, textoStatus, pontos } = dadosUltimaAvaliacao;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Relatório de Avaliação Sanitária Escolar", 20, 20);

  doc.setFontSize(11);
  doc.text(`Escola: ${escola}`, 20, 40);
  doc.text(`Responsável: ${responsavel}`, 20, 48);
  doc.text(`Data: ${data}`, 20, 56);

  doc.setFontSize(13);
  doc.text("Diagnóstico Técnico", 20, 75);

  doc.setFontSize(11);
  doc.text(`Status: ${textoStatus}`, 20, 85);
  doc.text(`Pontuação técnica: ${pontos}`, 20, 93);

  doc.text(
    "Este diagnóstico é preliminar, baseado em checklist técnico\n" +
    "e evidências fotográficas. Não substitui laudo técnico\n" +
    "emitido por profissional habilitado.",
    20, 115
  );

  doc.save("avaliacao_sanitaria_escolar.pdf");
}
</script>

</body>
</html>



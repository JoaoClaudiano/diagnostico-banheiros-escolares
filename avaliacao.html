<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD4SQ88NVT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DD4SQ88NVT');
</script>

<title>CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
<meta name="theme-color" content="#1f4fd8">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  margin:0;
}

.nav-global{
  position:fixed;
  top:12px;
  left:12px;
  display:flex;
  gap:8px;
  z-index:9999;
}
.nav-global button,
.nav-global a{
  background:#1f4fd8;
  color:#fff;
  border:none;
  border-radius:50%;
  width:38px;
  height:38px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
}

.header{
  background:#1f4fd8;
  height:80px;
}

.logo-box{
  display:flex;
  justify-content:center;
  margin-top:-40px;
}
.logo-box img{
  height:90px;
}

.container{
  max-width:900px;
  margin:20px auto;
  padding:0 16px;
}

h1{
  text-align:center;
  margin:20px 0;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

label{
  font-weight:bold;
  display:block;
  margin-bottom:6px;
}

select,input[type="text"],input[type="file"]{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:14px;
}

.categoria{
  margin-bottom:26px;
}
.categoria h3{
  color:#1f4fd8;
  margin-bottom:12px;
}

.checklist{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.check-card{
  border:2px solid #e0e0e0;
  border-radius:12px;
  padding:16px;
  cursor:pointer;
  background:#fafafa;
  transition:.2s;
}
.check-card input{display:none;}
.check-card:hover{
  border-color:#1f4fd8;
  background:#f0f5ff;
}
.check-card:has(input:checked){
  border-color:#1f4fd8;
  background:#eaf0ff;
  font-weight:bold;
}

.preview{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.preview img{
  width:120px;
  height:90px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  width:100%;
  padding:16px;
  background:#1f4fd8;
  color:#fff;
  font-size:16px;
  font-weight:bold;
  border:none;
  border-radius:12px;
  cursor:pointer;
}
button:hover{background:#163ca6;}

.resultado{
  margin-top:20px;
  padding:20px;
  border-radius:12px;
  display:none;
  font-weight:bold;
}
.ok{background:#e8f7ee;color:#1e7e34;}
.alerta{background:#fff3cd;color:#856404;}
.critico{background:#f8d7da;color:#721c24;}
  
#offlineCard {
  background:#fff8e1;
  color:#856404;
}
</style>
</head>

<body>

<div class="nav-global">
  <button onclick="history.back()">‚¨ÖÔ∏è</button>
  <a href="./index.html">üè†</a>
</div>

<div class="header"></div>

<div class="logo-box">
  <img src="./logo.png" alt="CheckInfra">
</div>

<div class="container">

<h1>Avalia√ß√£o Sanit√°ria Escolar</h1>
  <div id="offlineCard" class="card" style="display:none; border-left:6px solid #f0ad4e;">
  <strong>üì¥ Modo offline ativo</strong><br>
  Os dados est√£o sendo salvos no dispositivo e ser√£o sincronizados automaticamente
  quando a conex√£o com a internet for restabelecida.
</div>
  
<form id="form-avaliacao">

<div class="card">
  <label>Escola</label>
  <select id="escola">
    <option value="">Selecione a escola</option>
  </select>

  <label>Avaliador</label>
  <input type="text" id="avaliador" placeholder="Nome do avaliador">
</div>

<div class="card">

<div class="categoria">
<h3>üèóÔ∏è Estrutura</h3>
<div class="checklist">
<label class="check-card">
<input type="checkbox" data-peso="3"> Mofo ou umidade excessiva
</label>
<label class="check-card">
<input type="checkbox" data-peso="2"> Piso quebrado ou escorregadio
</label>
<label class="check-card">
<input type="checkbox" data-peso="2"> Infiltra√ß√µes vis√≠veis
</label>
</div>
</div>

<div class="categoria">
<h3>üßπ Higiene</h3>
<div class="checklist">
<label class="check-card">
<input type="checkbox" data-peso="2"> Limpeza inadequada
</label>
<label class="check-card">
<input type="checkbox" data-peso="2"> Mau cheiro persistente
</label>
</div>
</div>

<div class="categoria">
<h3>üí° Conforto</h3>
<div class="checklist">
<label class="check-card">
<input type="checkbox" data-peso="1"> Ilumina√ß√£o insuficiente
</label>
<label class="check-card">
<input type="checkbox" data-peso="1"> Ventila√ß√£o inadequada
</label>
</div>
</div>

</div>

<div class="card">
<h3>üì∑ Registro Fotogr√°fico</h3>
<input type="file" id="fotos" accept="image/*" multiple>
<div class="preview" id="preview"></div>
</div>

<button type="submit">Gerar Diagn√≥stico</button>

</form>

<div id="resultado" class="resultado"></div>
</div>

<script src="./mapa/escolas.js"></script>
<script src="./js/avaliacao-offline.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const select=document.getElementById("escola");
  if(window.escolas){
    window.escolas.forEach(e=>{
      const o=document.createElement("option");
      o.value=e.nome;
      o.textContent=e.nome;
      select.appendChild(o);
    });
  }
});
</script>

<script>
document.getElementById("form-avaliacao").addEventListener("submit",async e=>{
  e.preventDefault();

  const escola=escola.value;
  const avaliador=avaliador.value;

  let score=0, problemas=[];
  document.querySelectorAll("input[type=checkbox]:checked").forEach(c=>{
    score+=parseInt(c.dataset.peso);
    problemas.push(c.parentElement.innerText.trim());
  });

  let status="ok";
  if(score>=6) status="critico";
  else if(score>=3) status="alerta";

  if(window.salvarAvaliacao){
    await salvarAvaliacao({escola,avaliador,score,status,problemas});
  }

  const r=document.getElementById("resultado");
  r.className="resultado "+status;
  r.style.display="block";
  r.innerHTML=`Status: ${status.toUpperCase()}<br>Pontua√ß√£o: ${score}`;
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain:"checkinfra-adf3c.firebaseapp.com",
  projectId:"checkinfra-adf3c",
  storageBucket:"checkinfra-adf3c.appspot.com",
  messagingSenderId:"206434271838",
  appId:"1:206434271838:web:347d68e6956fe26ee1eacf"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

window.salvarAvaliacao=async dados=>{
  await addDoc(collection(db,"avaliacoes"),{
    ...dados,
    createdAt:serverTimestamp()
  });
};
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>

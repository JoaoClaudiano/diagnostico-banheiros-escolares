<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa Sanit√°rio ‚Äì Escolas Municipais</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }
header {
  background:#1f4fd8;
  color:#fff;
  padding:14px 12px;
  text-align:center;
  font-weight:bold;
  font-size:16px;
  position:sticky;
  top:0;
  z-index:1000;
}

.nav-global {
  position:fixed;
  top:12px;
  left:10px;
  display:flex;
  gap:8px;
  z-index:1100;
}
.nav-global button, .nav-global a {
  background:#1f4fd8;
  color:#fff;
  border:none;
  border-radius:50%;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  text-decoration:none;
  cursor:pointer;
}

.painel {
  background:#f4f6f8;
  padding:6px 10px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  font-size:13px;
  position:sticky;
  top:52px;
  z-index:999;
  border-bottom:1px solid #ddd;
}

.painel label { display:flex; align-items:center; gap:4px; cursor:pointer; }

.bola { width:12px; height:12px; border-radius:50%; }
.verde { background:#4CAF50; }
.laranja { background:#FFD700; }
.amarela { background:#FF9800; }
.vermelho { background:#F44336; }

#map { height: calc(100vh - 110px); }

.legenda {
  background:#fff;
  padding:8px;
  font-size:12px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}

.pulse { animation: pulse 2.2s ease-out infinite; }
@keyframes pulse {
  0% { opacity:.9; }
  70% { opacity:.2; }
  100% { opacity:.9; }
}
</style>
</head>

<body>

<header>Mapa Sanit√°rio das Escolas ‚Äì Gest√£o Territorial</header>

<div class="nav-global">
  <button onclick="history.back()">‚¨ÖÔ∏è</button>
  <a href="../index.html">üè†</a>
</div>

<div class="painel">
  <label><input type="checkbox" id="chkPoligonos" checked> Pol√≠gonos por bairro</label>
  <label><input type="checkbox" id="chkPulso" checked> Mapa vivo</label>
</div>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= MAPA ================= */
const map = L.map("map").setView([-3.7319, -38.5267], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

let avaliacoes = [];
let camadaPoligonos;

/* ================= CORES ================= */
function corPorStatusDominante(p) {
  if (p.critico >= 50) return "#F44336";
  if (p.critico > 0) return "#F44336";
  if (p.atencao > 0) return "#FF9800";
  if (p.alerta > 0) return "#FFD700";
  return "#4CAF50";
}

/* ================= CARREGAR AVALIA√á√ïES ================= */
async function carregarAvaliacoes() {
  const snap = await getDocs(collection(db,"avaliacoes"));
  avaliacoes = [];
  snap.forEach(doc=>{
    const d = doc.data();
    if(d.lat && d.lng) avaliacoes.push(d);
  });
}

/* ================= PONTOS ================= */
function desenharPontos() {
  avaliacoes.forEach(d=>{
    const cor =
      d.status.includes("Cr√≠tica") ? "#F44336" :
      d.status.includes("Aten√ß√£o") ? "#FF9800" :
      d.status.includes("Alerta") ? "#FFD700" :
      "#4CAF50";

    L.circleMarker([d.lat,d.lng],{
      radius:7,
      color:cor,
      fillColor:cor,
      fillOpacity:.8,
      className: document.getElementById("chkPulso").checked ? "pulse" : ""
    })
    .bindPopup(`<strong>${d.escola}</strong><br>Status: ${d.status}<br>Pontua√ß√£o: ${d.pontuacao}`)
    .addTo(map);
  });
}

/* ================= POL√çGONOS ================= */
async function desenharPoligonos() {
  const geojson = await fetch("./POLIGONAIS.geojson").then(r=>r.json());

  camadaPoligonos = L.geoJSON(geojson,{
    style: f => {
      const stats = calcularStats(f);
      return {
        color:"#555",
        weight:1,
        fillColor: corPorStatusDominante(stats),
        fillOpacity:0.55
      };
    },
    onEachFeature:(f,l)=>{
      const s = calcularStats(f);
      l.bindTooltip(`
        <strong>${f.properties.nome || "Bairro"}</strong><br>
        üü• Cr√≠tico: ${s.critico}%<br>
        üü† Aten√ß√£o: ${s.atencao}%<br>
        üü° Alerta: ${s.alerta}%<br>
        üü¢ Adequado: ${s.adequado}%
      `,{sticky:true});
    }
  }).addTo(map);
}

/* ================= C√ÅLCULO ESPACIAL ================= */
function calcularStats(feature){
  let total=0, crit=0, aten=0, alert=0, adeq=0;

  avaliacoes.forEach(d=>{
    const p = L.latLng(d.lat,d.lng);
    if(L.geoJSON(feature).getBounds().contains(p)){
      total++;
      if(d.status.includes("Cr√≠tica")) crit++;
      else if(d.status.includes("Aten√ß√£o")) aten++;
      else if(d.status.includes("Alerta")) alert++;
      else adeq++;
    }
  });

  if(total===0) return {critico:0,atencao:0,alerta:0,adequado:0};

  return {
    critico: Math.round(crit/total*100),
    atencao: Math.round(aten/total*100),
    alerta: Math.round(alert/total*100),
    adequado: Math.round(adeq/total*100)
  };
}

/* ================= INIT ================= */
await carregarAvaliacoes();
desenharPontos();
await desenharPoligonos();

document.getElementById("chkPoligonos").addEventListener("change",e=>{
  if(e.target.checked) map.addLayer(camadaPoligonos);
  else map.removeLayer(camadaPoligonos);
});
</script>

</body>
</html>
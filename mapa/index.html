<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa Sanit√°rio ‚Äì Escolas Municipais</title>

<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; background:#f4f6f8; }
header { background:#1f4fd8; color:#fff; text-align:center; padding:14px 10px; font-size:16px; font-weight:bold; }
.nav-global { position:fixed; top:0; left:0; right:0; display:flex; gap:8px; justify-content:flex-start; padding:8px; z-index:9999; background: rgba(31,79,216,0.95); }
.nav-global button, .nav-global a { background:#1f4fd8; color:#fff; border:none; border-radius:50%; width:38px; height:38px; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; }
.nav-global button:hover, .nav-global a:hover { background:#163aa9; }

#map { height: calc(100vh - 160px); margin-top:58px; }

.painel { padding:10px; background:#f4f6f8; display:flex; gap:10px; justify-content:center; font-size:14px; flex-wrap:wrap; position:sticky; top:58px; z-index:999; }
.painel label { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:13px; }
.bola { width:12px; height:12px; border-radius:50%; display:inline-block; }
.verde { background:#4CAF50; }      /* Adequado */
.laranja { background:#FFD700; }    /* Alerta */
.amarela { background:#FF9800; }    /* Aten√ß√£o */
.vermelho { background:#F44336; }   /* Cr√≠tico */

/* Pulso animado */
.pulse-critico { animation: pulse-red 2.4s ease-out infinite; }
.pulse-alerta  { animation: pulse-yellow 2.4s ease-out infinite; }
.pulse-atencao { animation: pulse-orange 2.4s ease-out infinite; }
.pulse-adequado{ animation: pulse-green 2.4s ease-out infinite; }

@keyframes pulse-red { 0% { r:8; opacity:.9; } 70% { r:18; opacity:0; } 100% { opacity:0; } }
@keyframes pulse-yellow { 0% { r:8; opacity:.8; } 70% { r:16; opacity:0; } 100% { opacity:0; } }
@keyframes pulse-orange { 0% { r:8; opacity:.8; } 70% { r:16; opacity:0; } 100% { opacity:0; } }
@keyframes pulse-green { 0% { r:8; opacity:.7; } 70% { r:14; opacity:0; } 100% { opacity:0; } }

/* Legenda */
.legenda { background:#fff; padding:10px; font-size:13px; border-radius:6px; box-shadow:0 1px 5px rgba(0,0,0,.3); }
.legenda h4 { margin:0 0 6px; font-size:14px; }
.legenda div { display:flex; align-items:center; gap:6px; margin-bottom:4px; }

/* Footer */
footer { background:#1f4fd8; color:#fff; text-align:center; padding:16px 10px; font-size:12px; line-height:1.4; width:100%; box-sizing:border-box; }
footer div { max-width:600px; margin:0 auto; }
footer a { color:#fff; text-decoration:underline; }

@media (max-width:480px){
  footer p { font-size:10px; }
  footer img { width:60%; }
}
</style>
</head>
<body>

<div class="nav-global">
  <button onclick="history.back()" title="Voltar">‚¨ÖÔ∏è</button>
  <a href="./index.html" title="In√≠cio">üè†</a>
</div>

<header>Mapa Sanit√°rio das Escolas ‚Äì Secretaria de Educa√ß√£o</header>

<div class="painel">
  <label><input type="checkbox" id="filtroAdequado" checked><span class="bola verde"></span> Adequado</label>
  <label><input type="checkbox" id="filtroAlerta" checked><span class="bola laranja"></span> Alerta</label>
  <label><input type="checkbox" id="filtroAtencao" checked><span class="bola amarela"></span> Aten√ß√£o</label>
  <label><input type="checkbox" id="filtroCritico" checked><span class="bola vermelho"></span> Cr√≠tico</label>
  <label><input type="checkbox" id="togglePulso" checked> Mapa vivo</label>
</div>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const map = L.map("map").setView([-3.7319, -38.5267], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬©Ô∏è OpenStreetMap" }).addTo(map);

let pulsoAtivo = true;
document.getElementById("togglePulso").addEventListener("change", e=>{
  pulsoAtivo = e.target.checked;
  atualizarMapa();
});

function corPorStatus(status){
  status = status.toLowerCase();
  if(status.includes("cr√≠tica")) return "#F44336";
  if(status.includes("aten√ß√£o")) return "#FF9800";
  if(status.includes("alerta")) return "#FFD700";
  return "#4CAF50";
}

function classePulso(status){
  if(!pulsoAtivo) return "";
  status = status.toLowerCase();
  if(status.includes("cr√≠tica")) return "pulse-critico";
  if(status.includes("aten√ß√£o")) return "pulse-atencao";
  if(status.includes("alerta")) return "pulse-alerta";
  return "pulse-adequado";
}

function criarMarker(d){
  return L.circleMarker([d.lat,d.lng],{
    radius:8, color:corPorStatus(d.status), fillColor:corPorStatus(d.status),
    fillOpacity:.8, className:classePulso(d.status)
  }).bindPopup(`<strong>${d.escola}</strong><br>Status: ${d.status}<br>Pontua√ß√£o: ${d.pontuacao}`);
}

let avaliacoes = [];

async function carregarAvaliacoes(){
  const snapshot = await getDocs(query(collection(db,"avaliacoes"), orderBy("createdAt","desc")));
  const escolasMap = new Map();
  snapshot.forEach(doc=>{
    const d = doc.data();
    if(d.lat && d.lng && !escolasMap.has(d.escola)){
      escolasMap.set(d.escola,d);
    }
  });
  avaliacoes = Array.from(escolasMap.values());
}

function atualizarMapa(){
  map.eachLayer(l=>{
    if(l instanceof L.MarkerClusterGroup || l instanceof L.LayerGroup) l.clearLayers();
  });

  const filtrar = d=>{
    if(d.status.toLowerCase().includes("cr√≠tica") && !document.getElementById("filtroCritico").checked) return false;
    if(d.status.toLowerCase().includes("aten√ß√£o") && !document.getElementById("filtroAtencao").checked) return false;
    if(d.status.toLowerCase().includes("alerta") && !document.getElementById("filtroAlerta").checked) return false;
    if(d.status.toLowerCase().includes("adequado") && !document.getElementById("filtroAdequado").checked) return false;
    return true;
  };

  const avaliFiltradas = avaliacoes.filter(filtrar);

  if(pulsoAtivo){
    const cluster = L.markerClusterGroup({ chunkedLoading:true });
    avaliFiltradas.forEach(d=> cluster.addLayer(criarMarker(d)) );
    map.addLayer(cluster);
  } else {
    avaliFiltradas.forEach(d=>{
      criarMarker(d).addTo(map);
    });
  }
}

document.getElementById("filtroAdequado").addEventListener("change", atualizarMapa);
document.getElementById("filtroAlerta").addEventListener("change", atualizarMapa);
document.getElementById("filtroAtencao").addEventListener("change", atualizarMapa);
document.getElementById("filtroCritico").addEventListener("change", atualizarMapa);

async function initMap(){
  await carregarAvaliacoes();
  atualizarMapa();
}
initMap();

// Legenda
const legenda = L.control({ position: "bottomright" });
legenda.onAdd = function(){
  const div = L.DomUtil.create("div","legenda");
  div.innerHTML = `
    <h4>Leitura do mapa</h4>
    <div><span class="bola verde"></span> Situa√ß√£o adequada</div>
    <div><span class="bola laranja"></span> Alerta</div>
    <div><span class="bola amarela"></span> Aten√ß√£o</div>
    <div><span class="bola vermelho"></span> Cr√≠tico</div>
    <hr>
    <small>O pulso indica intensidade relativa de aten√ß√£o territorial.<br>N√£o substitui inspe√ß√£o t√©cnica presencial.</small>
  `;
  return div;
};
legenda.addTo(map);
</script>

<footer>
  <div>
    <p>¬© 2025 CheckInfra ‚Äî Projeto acad√™mico e tecnol√≥gico ‚Äî C√≥digo licenciado sob MIT License</p>
    <p>
      <a href="./pages/sobre.html">Sobre</a> | 
      <a href="./pages/contato.html">Contato</a> | 
      <a href="./pages/politica-privacidade.html">Pol√≠tica de Privacidade</a> | 
      <a href="./pages/termos-de-uso.html">Termos de Uso</a>
    </p>
    <p>
      <a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener noreferrer">
        <img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT" style="max-width:90px; width:40%;">
      </a>
    </p>
    <p style="font-size:11px;">
      üîí O CheckInfra realiza tratamento m√≠nimo de dados pessoais, exclusivamente para fins t√©cnicos e institucionais.
    </p>
  </div>
</footer>

</body>
</html>
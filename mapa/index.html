<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>CheckInfra ‚Äì Mapa Sanit√°rio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- LEAFLET -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      background: #1f4fd8;
      color: #fff;
      padding: 14px 20px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    #map {
      height: calc(100vh - 56px);
      width: 100%;
    }

    .popup h3 {
      margin: 0 0 6px;
      font-size: 15px;
    }

    .popup p {
      margin: 4px 0;
      font-size: 13px;
    }

    .ok { color:#28a745; font-weight:bold; }
    .alerta { color:#856404; font-weight:bold; }
    .critico { color:#721c24; font-weight:bold; }
  </style>
</head>

<body>

<header>
  Mapa Sanit√°rio das Escolas ‚Äì CheckInfra
</header>

<div id="map"></div>

<!-- LEAFLET JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* üîó MESMO URL EXEC */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIqrAdgd7pLsW0kYAnrrHQ-WrCsnbR4Eh9BpkamYbrKwCOFP5fH6N52HFw2nOz2t2G/exec";

/* üìç MAPA BASE (FORTALEZA) */
const map = L.map("map").setView([-3.7319, -38.5267], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

/* üéØ √çCONES POR STATUS */
function criarIcone(cor) {
  return new L.Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${cor}.png`,
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

const icones = {
  ok: criarIcone("green"),
  alerta: criarIcone("yellow"),
  critico: criarIcone("red")
};

/* üì• BUSCA AVALIA√á√ïES DO SHEETS */
fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(dados => {
    dados.forEach(item => {

      if (!item.lat || !item.lng) return;

      const marker = L.marker(
        [item.lat, item.lng],
        { icon: icones[item.statusClass] || icones.ok }
      ).addTo(map);

      marker.bindPopup(`
        <div class="popup">
          <h3>${item.escola}</h3>
          <p><strong>Avaliador:</strong> ${item.avaliador}</p>
          <p><strong>Pontua√ß√£o:</strong> ${item.pontuacao}</p>
          <p><strong>Status:</strong>
            <span class="${item.statusClass}">
              ${item.status}
            </span>
          </p>
          <p><strong>Problemas:</strong><br>
            ${item.problemas || "Nenhum"}
          </p>
        </div>
      `);
    });
  })
  .catch(() => {
    alert("Erro ao carregar dados do mapa.");
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Mapa Sanit√°rio ‚Äì Escolas Municipais</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
body { margin:0; font-family: Arial, sans-serif; }
.nav-global { position: fixed; top: 12px; left: 12px; display: flex; gap: 8px; z-index: 9999; }
.nav-global button, .nav-global a {
  background: rgba(31,79,216,0.95); color: #fff; border: none; border-radius: 50%;
  width: 38px; height: 38px; cursor: pointer; font-size: 18px;
  display: flex; align-items: center; justify-content: center; text-decoration: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.nav-global button:hover, .nav-global a:hover { background: #163aa9; }
header { background:#1f4fd8; color:#fff; padding:12px; text-align:center; font-weight:bold; }

#map { height: calc(100vh - 170px); }

.painel { padding:10px; background:#f4f6f8; display:flex; gap:15px; justify-content:center; font-size:14px; flex-wrap:wrap; }
.painel label { display:flex; align-items:center; gap:6px; cursor:pointer; }
.bola { width:12px; height:12px; border-radius:50%; display:inline-block; }
.verde { background:green; }
.laranja { background:orange; }
.vermelho { background:red; }

/* Pulso cartogr√°fico */
.pulse-critico { animation: pulse-red 2.4s ease-out infinite; }
.pulse-alerta  { animation: pulse-orange 2.4s ease-out infinite; }
.pulse-adequado{ animation: pulse-green 2.4s ease-out infinite; }
@keyframes pulse-red { 0% { r:8; opacity:.9; } 70% { r:18; opacity:0; } 100% { opacity:0; } }
@keyframes pulse-orange { 0% { r:8; opacity:.8; } 70% { r:16; opacity:0; } 100% { opacity:0; } }
@keyframes pulse-green { 0% { r:8; opacity:.7; } 70% { r:14; opacity:0; } 100% { opacity:0; } }

.legenda { background:#fff; padding:10px; font-size:13px; border-radius:6px; box-shadow:0 1px 5px rgba(0,0,0,.3); }
.legenda h4 { margin:0 0 6px; font-size:14px; }
.legenda div { display:flex; align-items:center; gap:6px; margin-bottom:4px; }

.zoom-todos {
  position: fixed; bottom: 90px; right: 12px; z-index: 9999;
  background: #1f4fd8; color: #fff; border:none; padding:10px 14px; border-radius:6px;
  cursor:pointer; font-weight:bold; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.zoom-todos:hover { background:#163aa9; }
</style>
</head>

<body>
<div class="nav-global">
  <button onclick="history.back()" title="Voltar">‚¨ÖÔ∏è</button>
  <a href="./index.html" title="In√≠cio">üè†</a>
</div>

<header>Mapa Sanit√°rio das Escolas ‚Äì Secretaria de Educa√ß√£o</header>

<div class="painel">
  <label><input type="checkbox" id="filtroAdequado" checked><span class="bola verde"></span> Adequado</label>
  <label><input type="checkbox" id="filtroAlerta" checked><span class="bola laranja"></span> Alerta</label>
  <label><input type="checkbox" id="filtroCritico" checked><span class="bola vermelho"></span> Cr√≠tico</label>
  <label><input type="checkbox" id="togglePulso" checked> Mapa vivo</label>
</div>

<button class="zoom-todos" id="zoomTodos">üìç Zoom em todas as escolas</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const map = L.map("map").setView([-3.7319, -38.5267], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬©Ô∏è OpenStreetMap" }).addTo(map);

let pulsoAtivo = true;

// Criar grupos de clusters
const clusters = L.markerClusterGroup({ chunkedLoading:true, iconCreateFunction: cluster => {
  const markers = cluster.getAllChildMarkers();
  let statusPredominante = 'adequado';
  const countCritico = markers.filter(m => m.options.status === 'cr√≠tica').length;
  const countAlerta = markers.filter(m => m.options.status === 'alerta').length;
  const countAdequado = markers.filter(m => m.options.status === 'adequada').length;
  if (countCritico >= countAlerta && countCritico >= countAdequado) statusPredominante='cr√≠tica';
  else if (countAlerta >= countAdequado) statusPredominante='alerta';

  const cor = statusPredominante==='cr√≠tica'?'red': statusPredominante==='alerta'?'orange':'green';
  return L.divIcon({ html:`<div style="background:${cor};border-radius:50%;padding:5px;color:#fff;">${cluster.getChildCount()}</div>`, className:'cluster-icon', iconSize:null });
}});

function corPorStatus(status) {
  if (status.toLowerCase().includes("cr√≠tica")) return "red";
  if (status.toLowerCase().includes("alerta")) return "orange";
  return "green";
}
function classePulso(status) {
  if (!pulsoAtivo) return "";
  if (status.toLowerCase().includes("cr√≠tica")) return "pulse-critico";
  if (status.toLowerCase().includes("alerta")) return "pulse-alerta";
  return "pulse-adequado";
}

let todosMarkers = [];

// Carregar escolas do Firebase
async function carregarEscolas() {
  const snapshot = await getDocs(collection(db,"avaliacoes"));
  snapshot.forEach(docSnap => {
    const e = docSnap.data();
    if (!e.lat || !e.lng) return;

    const marker = L.circleMarker([e.lat,e.lng],{
      radius: window.innerWidth<600?10:8,
      color: corPorStatus(e.status),
      fillColor: corPorStatus(e.status),
      fillOpacity:0.8,
      className: classePulso(e.status),
      status: e.status.toLowerCase()
    }).bindPopup(`<strong>${e.escola}</strong><br>Status: ${e.status}<br>Pontua√ß√£o: ${e.pontuacao}`);

    clusters.addLayer(marker);
    todosMarkers.push(marker);
  });

  map.addLayer(clusters);
}
carregarEscolas();

// Filtros
document.getElementById("filtroAdequado").addEventListener("change", e => {
  clusters.eachLayer(m => m.options.status==='adequada' ? (e.target.checked?clusters.addLayer(m):clusters.removeLayer(m)) : null);
});
document.getElementById("filtroAlerta").addEventListener("change", e => {
  clusters.eachLayer(m => m.options.status==='alerta' ? (e.target.checked?clusters.addLayer(m):clusters.removeLayer(m)) : null);
});
document.getElementById("filtroCritico").addEventListener("change", e => {
  clusters.eachLayer(m => m.options.status==='cr√≠tica' ? (e.target.checked?clusters.addLayer(m):clusters.removeLayer(m)) : null);
});

// Toggle pulso
document.getElementById("togglePulso").addEventListener("change", e => {
  pulsoAtivo = e.target.checked;
  location.reload();
});

// Zoom em todos
document.getElementById("zoomTodos").addEventListener("click", () => {
  const group = L.featureGroup(todosMarkers);
  map.fitBounds(group.getBounds().pad(0.1));
});

// Legenda
const legenda = L.control({ position:"bottomright" });
legenda.onAdd = function(){ 
  const div=L.DomUtil.create("div","legenda");
  div.innerHTML=`<h4>Leitura do mapa</h4>
    <div><span class="bola verde"></span> Situa√ß√£o adequada</div>
    <div><span class="bola laranja"></span> Requer aten√ß√£o</div>
    <div><span class="bola vermelho"></span> Prioridade de interven√ß√£o</div>
    <hr>
    <small>O pulso indica intensidade relativa de aten√ß√£o territorial. N√£o substitui inspe√ß√£o t√©cnica presencial.</small>`;
  return div;
};
legenda.addTo(map);

</script>
</body>
</html>

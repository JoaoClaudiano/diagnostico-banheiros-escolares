<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa Sanit√°rio ‚Äì Escolas Municipais</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase v8 compat -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1f4fd8;
  color:#fff;
  padding:14px 12px;
  text-align:center;
  font-weight:bold;
  font-size:16px;
  position:sticky;
  top:0;
  z-index:999;
}

.nav-global {
  position: fixed;
  top:14px;
  left:10px;
  display:flex;
  gap:8px;
  z-index:9999;
}

.nav-global button,
.nav-global a {
  background:#1f4fd8;
  color:#fff;
  border:none;
  border-radius:50%;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  text-decoration:none;
  cursor:pointer;
}

.nav-global button:hover,
.nav-global a:hover {
  background:#163aa9;
}

/* Painel */
.painel {
  padding:6px 10px;
  background:#f4f6f8;
  display:flex;
  gap:10px;
  justify-content:center;
  font-size:13px;
  flex-wrap:wrap;
  position:sticky;
  top:52px;
  z-index:998;
  border-bottom:1px solid #ddd;
}

.painel label {
  display:flex;
  align-items:center;
  gap:4px;
  cursor:pointer;
}

.bola {
  width:12px;
  height:12px;
  border-radius:50%;
  display:inline-block;
}

.verde { background:#4CAF50; }
.laranja { background:#FFD700; }
.amarela { background:#FF9800; }
.vermelho { background:#F44336; }

/* Pulso */
.pulse-critico { animation: pulse-red 2.4s ease-out infinite; }
.pulse-alerta { animation: pulse-yellow 2.4s ease-out infinite; }
.pulse-atencao { animation: pulse-orange 2.4s ease-out infinite; }
.pulse-adequado { animation: pulse-green 2.4s ease-out infinite; }

@keyframes pulse-red {
  0% { r:8; opacity:.9; }
  70% { r:18; opacity:0; }
}

@keyframes pulse-yellow {
  0% { r:8; opacity:.8; }
  70% { r:16; opacity:0; }
}

@keyframes pulse-orange {
  0% { r:8; opacity:.8; }
  70% { r:16; opacity:0; }
}

@keyframes pulse-green {
  0% { r:8; opacity:.7; }
  70% { r:14; opacity:0; }
}

#map {
  height: calc(100vh - 110px);
}

/* Legenda */
.legenda {
  background:#fff;
  padding:8px;
  font-size:12px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}
</style>
</head>

<body>

<header>Mapa Sanit√°rio das Escolas ‚Äì Secretaria de Educa√ß√£o</header>

<div class="nav-global">
  <button onclick="history.back()">‚¨ÖÔ∏è</button>
  <a href="../index.html">üè†</a>
</div>

<div class="painel">
  <label><input type="checkbox" id="filtroAdequado" checked><span class="bola verde"></span> Adequado</label>
  <label><input type="checkbox" id="filtroAlerta" checked><span class="bola laranja"></span> Alerta</label>
  <label><input type="checkbox" id="filtroAtencao" checked><span class="bola amarela"></span> Aten√ß√£o</label>
  <label><input type="checkbox" id="filtroCritico" checked><span class="bola vermelho"></span> Cr√≠tico</label>
  <label><input type="checkbox" id="togglePulso" checked> Mapa vivo</label>
</div>

<div id="map"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
});
const db = firebase.firestore();

/* ================= MAPA ================= */
const map = L.map("map").setView([-3.7319, -38.5267], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

let pulsoAtivo = true;

document.getElementById("togglePulso").addEventListener("change", e => {
  pulsoAtivo = e.target.checked;
  atualizarMapa();
});

const camadaAdequado = L.layerGroup().addTo(map);
const camadaAlerta = L.layerGroup().addTo(map);
const camadaAtencao = L.layerGroup().addTo(map);
const camadaCritico = L.layerGroup().addTo(map);

function corPorStatus(s) {
  s = s.toLowerCase();
  if (s.includes("cr√≠tica")) return "#F44336";
  if (s.includes("aten√ß√£o")) return "#FF9800";
  if (s.includes("alerta")) return "#FFD700";
  return "#4CAF50";
}

function classePulso(s) {
  if (!pulsoAtivo) return "";
  s = s.toLowerCase();
  if (s.includes("cr√≠tica")) return "pulse-critico";
  if (s.includes("aten√ß√£o")) return "pulse-atencao";
  if (s.includes("alerta")) return "pulse-alerta";
  return "pulse-adequado";
}

let avaliacoes = [];

async function carregarAvaliacoes() {
  const snap = await db.collection("avaliacoes").get();
  avaliacoes = [];
  snap.forEach(doc => {
    const d = doc.data();
    if (d.lat && d.lng) avaliacoes.push(d);
  });
}

function atualizarMapa() {
  [camadaAdequado, camadaAlerta, camadaAtencao, camadaCritico].forEach(l => l.clearLayers());

  avaliacoes.forEach(d => {
    const status = d.status.toLowerCase();

    if (status.includes("cr√≠tica") && !filtroCritico.checked) return;
    if (status.includes("aten√ß√£o") && !filtroAtencao.checked) return;
    if (status.includes("alerta") && !filtroAlerta.checked) return;
    if (status.includes("adequado") && !filtroAdequado.checked) return;

    const marker = L.circleMarker([d.lat, d.lng], {
      radius: 8,
      color: corPorStatus(d.status),
      fillColor: corPorStatus(d.status),
      fillOpacity: .85,
      className: classePulso(d.status)
    }).bindPopup(
      `<strong>${d.escola}</strong><br>Status: ${d.status}<br>Pontua√ß√£o: ${d.pontuacao}`
    );

    if (status.includes("cr√≠tica")) marker.addTo(camadaCritico);
    else if (status.includes("aten√ß√£o")) marker.addTo(camadaAtencao);
    else if (status.includes("alerta")) marker.addTo(camadaAlerta);
    else marker.addTo(camadaAdequado);
  });
}

document.querySelectorAll(".painel input").forEach(el =>
  el.addEventListener("change", atualizarMapa)
);

(async function init() {
  await carregarAvaliacoes();
  atualizarMapa();
})();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Painel Gerencial – CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1f4fd8">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; margin:0; min-height:100vh; }

/* HEADER */
header{
  background:#1f4fd8;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
}
header h1{
  font-size:18px;
  margin:0;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
}
header button{
  background:none;
  border:none;
  color:#fff;
  font-size:20px;
  cursor:pointer;
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  top:0;
  right:-300px;
  width:300px;
  height:100%;
  background:#fff;
  box-shadow:-4px 0 10px rgba(0,0,0,.2);
  transition:.3s;
  z-index:999;
}
.sidebar.open{ right:0; }
.sidebar header{
  background:#1f4fd8;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.sidebar iframe{
  width:100%;
  height:calc(100% - 50px);
  border:none;
}

/* CARDS */
.card { background:#fff; max-width:1100px; margin:20px auto; padding:20px; border-radius:10px; }
.grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:16px; }
.kpi { background:#f9fafb; border-radius:10px; padding:16px; text-align:center; }
.kpi h4 { margin:0; font-size:14px; color:#555; }
.kpi strong { font-size:30px; display:block; margin-top:6px; }

/* BADGES */
.badge { padding:4px 8px; border-radius:12px; color:#fff; font-size:12px; }
.adequada { background:#4caf50; }
.alerta { background:yellow; color:#000; }
.atencao { background:#ff7043; }
.critica { background:#f44336; }

/* TABLE */
table { width:100%; border-collapse: collapse; font-size:14px; }
th, td { padding:8px; border-bottom:1px solid #eee; text-align:center; }
th { background:#f4f6f8; }

/* TABS */
.tabs { display:flex; gap:10px; margin-bottom:12px; }
.tab { padding:8px 16px; background:#e0e0e0; border-radius:6px; cursor:pointer; }
.tab.active { background:#1f4fd8; color:#fff; }

/* FOOTER */
footer {
  background:#1f4fd8;
  color:#fff;
  text-align:center;
  padding:16px;
  font-size:12px;
}
footer a{ color:#fff; text-decoration:underline; }
</style>
</head>

<body>

<header>
  <button onclick="history.back()">⬅️</button>
  <h1>Painel Gerencial – CheckInfra</h1>
  <button onclick="toggleSidebar()">☰</button>
</header>

<div class="sidebar" id="sidebar">
  <header>
    <span>Metodologia</span>
    <button onclick="toggleSidebar()">✖</button>
  </header>
  <iframe src="metodo.html"></iframe>
</div>

<div class="card grid">
  <div class="kpi">
    <h4>Unidades Críticas</h4>
    <strong id="kpiCritica">–</strong>
  </div>
  <div class="kpi">
    <h4>Unidades em Atenção</h4>
    <strong id="kpiAtencao">–</strong>
  </div>
  <div class="kpi">
    <h4>IPT Médio</h4>
    <strong id="kpiMedio">–</strong>
  </div>
  <div class="kpi">
    <h4>Problemas Frequentes</h4>
    <strong id="kpiProblemas">–</strong>
  </div>
</div>

<div class="card grid">
  <div>
    <h3>Status das Unidades</h3>
    <canvas id="graficoStatus"></canvas>
  </div>
  <div>
    <h3>Top Prioridades (IPT)</h3>
    <canvas id="graficoIndice"></canvas>
  </div>
  <div>
    <h3>Frequência de Problemas</h3>
    <canvas id="graficoProblemas"></canvas>
  </div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" onclick="mostrarAba('ranking')">Ranking</div>
    <div class="tab" onclick="mostrarAba('historico')">Histórico</div>
  </div>

  <div id="aba-ranking">
    <button onclick="exportarXLSX()">⬇️ Baixar Ranking</button>
    <table>
      <thead>
        <tr><th>#</th><th>Escola</th><th>Status</th><th>IPT</th><th>RT</th></tr>
      </thead>
      <tbody id="tabelaRanking"></tbody>
    </table>
  </div>

  <div id="aba-historico" style="display:none;">
    <button onclick="exportarHistorico()">⬇️ Baixar Histórico</button>
    <table>
      <thead>
        <tr><th>#</th><th>Escola</th><th>Status</th><th>IPT</th><th>Data</th></tr>
      </thead>
      <tbody id="tabelaHistorico"></tbody>
    </table>
  </div>
</div>

<footer>
  © 2025 CheckInfra —
  <a href="./pages/sobre.html">Sobre</a> |
  <a href="./pages/contato.html">Contato</a> |
  <a href="./pages/politica-privacidade.html">Política de Privacidade</a> |
  <a href="./pages/termos-de-uso.html">Termos de Uso</a>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tabelaRanking = document.getElementById("tabelaRanking");
const tabelaHistorico = document.getElementById("tabelaHistorico");

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("open");
}

function mostrarAba(aba){
  document.getElementById("aba-ranking").style.display="none";
  document.getElementById("aba-historico").style.display="none";
  document.getElementById("aba-"+aba).style.display="block";
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector(`.tab[onclick="mostrarAba('${aba}')"]`).classList.add("active");
}

async function carregarAvaliacoes(){
  const snap = await db.collection("avaliacoes").get();
  const dados = [];
  snap.forEach(d=>dados.push(d.data()));
  montar(dados);
}

function montar(dados){
  const mapa = {};
  const historico = [];

  dados.forEach(d=>{
    const escola = d.escola || "Sem nome";
    if(!mapa[escola]) mapa[escola]=[];
    mapa[escola].push(d);
  });

  const ranking = [];

  Object.keys(mapa).forEach(escola=>{
    const avals = mapa[escola].sort((a,b)=>b.createdAt.seconds-a.createdAt.seconds);
    const atual = avals[0];

    const status = (atual.status||"").toLowerCase();
    let GS=1, classe="adequada", label="Adequada";
    if(status.includes("crít")){GS=4;classe="critica";label="Crítica";}
    else if(status.includes("aten")){GS=3;classe="atencao";label="Atenção";}
    else if(status.includes("alerta")){GS=2;classe="alerta";label="Alerta";}

    const IT = Number(atual.pontuacao||0);

    const RT = Math.min(
      avals.filter(a=>(a.status||"").toLowerCase()===status).length,
      5
    );

    const IPT = (GS*0.4)+(IT*0.4)+(RT*0.2);

    ranking.push({escola,classe,label,IPT,RT});

    avals.forEach(a=>{
      historico.push({
        escola,
        classe,
        label,
        IPT,
        data: new Date(a.createdAt.seconds*1000).toISOString().split("T")[0]
      });
    });
  });

  ranking.sort((a,b)=>b.IPT-a.IPT);

  tabelaRanking.innerHTML="";
  ranking.forEach((r,i)=>{
    tabelaRanking.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${r.escola}</td>
        <td><span class="badge ${r.classe}">${r.label}</span></td>
        <td>${r.IPT.toFixed(2)}</td>
        <td>${r.RT}</td>
      </tr>`;
  });

  tabelaHistorico.innerHTML="";
  historico.forEach((r,i)=>{
    tabelaHistorico.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${r.escola}</td>
        <td><span class="badge ${r.classe}">${r.label}</span></td>
        <td>${r.IPT.toFixed(2)}</td>
        <td>${r.data}</td>
      </tr>`;
  });
}

carregarAvaliacoes();
</script>

</body>
</html>
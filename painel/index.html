<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Gerencial — CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1f4fd8">

<!-- Chart.js UMD (CORRETO) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f4f6f8;
}

/* HEADER */
header{
  background:#1f4fd8;
  color:#fff;
  display:flex;
  align-items:center;
  padding:12px;
  position:relative;
}
header h1{
  flex:1;
  text-align:center;
  margin:0;
  font-size:18px;
}
header button{
  background:none;
  border:none;
  color:#fff;
  font-size:20px;
  cursor:pointer;
}

/* CARDS */
.card{
  background:#fff;
  max-width:1100px;
  margin:16px auto;
  padding:20px;
  border-radius:10px;
}

/* KPI */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
}
.kpi{
  background:#f9fafb;
  border-radius:10px;
  padding:16px;
  text-align:center;
}
.kpi strong{font-size:28px;}

/* STATUS */
.badge{
  padding:4px 10px;
  border-radius:12px;
  color:#fff;
  font-size:12px;
}
.adequada{background:#4caf50}
.alerta{background:#fbc02d;color:#000}
.atencao{background:#ff7043}
.critica{background:#f44336}

/* TABELA */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  border-bottom:1px solid #eee;
  text-align:center;
}

/* GRÁFICOS */
.graficos{
  display:grid;
  grid-template-columns:1fr;
  gap:30px;
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  top:0;
  right:-100%;
  width:85%;
  max-width:360px;
  height:100%;
  background:#fff;
  box-shadow:-4px 0 10px rgba(0,0,0,.2);
  transition:.3s;
  z-index:999;
}
.sidebar.open{ right:0; }
.sidebar header{
  background:#1f4fd8;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.sidebar iframe{
  width:100%;
  height:calc(100% - 50px);
  border:none;
}

/* FOOTER */
footer{
  background:#1f4fd8;
  color:#fff;
  text-align:center;
  padding:14px;
  font-size:12px;
}
footer a{color:#fff;text-decoration:underline;}
</style>
</head>

<body>

<header>
  <button onclick="history.back()">←</button>
  <h1>Painel Gerencial — CheckInfra</h1>
  <button onclick="abrirSidebar()">☰</button>
</header>

<div class="card grid">
  <div class="kpi"><h4>Críticas</h4><strong id="kpiCritica">–</strong></div>
  <div class="kpi"><h4>Atenção</h4><strong id="kpiAtencao">–</strong></div>
  <div class="kpi"><h4>IPT Médio</h4><strong id="kpiMedio">–</strong></div>
  <div class="kpi"><h4>Problemas</h4><strong id="kpiProblemas">–</strong></div>
</div>

<div class="card graficos">
  <canvas id="graficoStatus" height="300"></canvas>
  <canvas id="graficoIndice" height="300"></canvas>
  <canvas id="graficoProblemas" height="300"></canvas>
</div>

<div class="card">
  <button onclick="exportarRanking()">⬇️ Ranking</button>
  <button onclick="exportarHistorico()">⬇️ Histórico</button>
  <table>
    <thead>
      <tr><th>#</th><th>Escola</th><th>Status</th><th>IPT</th></tr>
    </thead>
    <tbody id="tabelaRanking"></tbody>
  </table>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <header>
    <strong>Metodologia</strong>
    <button onclick="fecharSidebar()">✕</button>
  </header>
  <iframe src="metodo.html"></iframe>
</div>

<footer>
  <a href="/pages/sobre.html">Sobre</a> |
  <a href="/pages/contato.html">Contato</a> |
  <a href="/pages/politica-privacidade.html">Privacidade</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain:"checkinfra-adf3c.firebaseapp.com",
  projectId:"checkinfra-adf3c"
});
const db = getFirestore(app);

let chartStatus, chartIndice, chartProblemas;
let rankingGlobal=[], rankingHistorico=[];

function calcularIPT(status,pont,qtd){
  const GS = {adequada:1,alerta:2,atencao:3,critica:4}[status]||1;
  return (
    (GS/4)*0.4 +
    Math.min(pont/20,1)*0.4 +
    Math.min(qtd/5,1)*0.2
  );
}

async function carregar(){
  const snap = await getDocs(collection(db,"avaliacoes"));
  const dados = snap.docs.map(d=>d.data());
  montar(dados);
}

function montar(dados){
  const porEscola={}, problemas={};
  let critica=0, atencao=0, soma=0;

  dados.forEach(d=>{
    const escola=d.escola||"—";
    porEscola[escola]=(porEscola[escola]||[]);
    porEscola[escola].push(d);
    (d.problemas||[]).forEach(p=>problemas[p]=(problemas[p]||0)+1);
  });

  rankingGlobal=[];
  Object.entries(porEscola).forEach(([escola,av])=>{
    av.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    const r=av[0];
    const status=r.status.toLowerCase();
    const IPT=calcularIPT(status,r.pontuacao,av.length);
    soma+=IPT;
    if(status==="critica")critica++;
    if(status==="atencao")atencao++;
    rankingGlobal.push({escola,status,IPT});
  });

  document.getElementById("kpiCritica").innerText=critica;
  document.getElementById("kpiAtencao").innerText=atencao;
  document.getElementById("kpiMedio").innerText=(soma/rankingGlobal.length).toFixed(2);
  document.getElementById("kpiProblemas").innerText=Object.keys(problemas).length;

  const tbody=document.getElementById("tabelaRanking");
  tbody.innerHTML="";
  rankingGlobal.sort((a,b)=>b.IPT-a.IPT).forEach((r,i)=>{
    tbody.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${r.escola}</td>
        <td><span class="badge ${r.status}">${r.status}</span></td>
        <td>${r.IPT.toFixed(2)}</td>
      </tr>`;
  });

  if(chartStatus)chartStatus.destroy();
  chartStatus=new Chart(graficoStatus,{
    type:"pie",
    data:{
      labels:["Adequada","Alerta","Atenção","Crítica"],
      datasets:[{data:[
        rankingGlobal.filter(r=>r.status==="adequada").length,
        rankingGlobal.filter(r=>r.status==="alerta").length,
        rankingGlobal.filter(r=>r.status==="atencao").length,
        rankingGlobal.filter(r=>r.status==="critica").length
      ]}]
    }
  });

  if(chartIndice)chartIndice.destroy();
  chartIndice=new Chart(graficoIndice,{
    type:"bar",
    data:{
      labels:rankingGlobal.map(r=>r.escola),
      datasets:[{data:rankingGlobal.map(r=>r.IPT)}]
    },
    options:{indexAxis:"y"}
  });

  if(chartProblemas)chartProblemas.destroy();
  chartProblemas=new Chart(graficoProblemas,{
    type:"bar",
    data:{
      labels:Object.keys(problemas),
      datasets:[{data:Object.values(problemas)}]
    },
    options:{indexAxis:"y"}
  });
}

window.abrirSidebar=()=>sidebar.classList.add("open");
window.fecharSidebar=()=>sidebar.classList.remove("open");
window.exportarRanking=()=>XLSX.writeFile(XLSX.utils.book_new(),"ranking.xlsx");
window.exportarHistorico=()=>XLSX.writeFile(XLSX.utils.book_new(),"historico.xlsx");

carregar();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>CheckInfra ‚Äî Painel</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}

h1{ margin-bottom:10px }

button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#1f4fd8;
  color:#fff;
  font-weight:600;
}

button + button{ margin-left:8px }

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-top:15px;
}

th,td{
  padding:8px;
  border-bottom:1px solid #ddd;
  text-align:center;
  font-size:14px;
}

th{ background:#f0f0f0 }

.badge{
  padding:4px 8px;
  border-radius:12px;
  color:#fff;
  font-size:12px;
  font-weight:600;
}

.selo-melhorou{ background:#4caf50 }
.selo-piorou{ background:#f44336 }
.selo-estavel{ background:#9e9e9e }
.selo-primeiro{ background:#1f4fd8 }

/* Modal */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#fff;
  padding:20px;
  width:90%;
  max-width:600px;
  border-radius:8px;
  max-height:80vh;
  overflow:auto;
}
</style>
</head>

<body>

<h1>Painel CheckInfra</h1>

<button onclick="exportarXLSX()">‚¨áÔ∏è Baixar XLSX</button>
<button onclick="abrirHistorico()">üìú Visualizar hist√≥rico</button>

<table>
<thead>
<tr>
  <th>Escola</th>
  <th>Status</th>
  <th>IPT</th>
  <th>Evolu√ß√£o</th>
  <th>Hist√≥rico IPT</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<!-- MODAL HIST√ìRICO -->
<div class="modal" id="modalHistorico" onclick="fecharHistorico()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3>üìú Hist√≥rico de Avalia√ß√µes</h3>
    <div id="conteudoHistorico"></div>
    <button onclick="fecharHistorico()">Fechar</button>
  </div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= MAIN ================= */
let cacheAvaliacoes = [];

async function carregar(){
  const snap = await getDocs(collection(db,"avaliacoes"));
  const porEscola = {};

  snap.forEach(doc=>{
    const d = doc.data();
    if(!d.escola || d.IPT == null || !d.createdAt) return;

    const ts = d.createdAt.seconds || 0;
    if(!porEscola[d.escola]) porEscola[d.escola] = [];
    porEscola[d.escola].push({...d,_ts:ts});
  });

  cacheAvaliacoes = porEscola;
  montarTabela();
}

function montarTabela(){
  const tbody = document.getElementById("tabela");
  tbody.innerHTML="";

  Object.entries(cacheAvaliacoes).forEach(([escola,lista],i)=>{
    lista.sort((a,b)=>a._ts-b._ts);

    const atual = lista[lista.length-1];
    const anterior = lista[lista.length-2];

    let selo="Primeira avalia√ß√£o",classe="selo-primeiro";
    if(anterior){
      const diff = atual.IPT - anterior.IPT;
      if(Math.abs(diff)<=0.05){ selo="Est√°vel"; classe="selo-estavel"; }
      else if(diff<0){ selo="Melhorou"; classe="selo-melhorou"; }
      else{ selo="Piorou"; classe="selo-piorou"; }
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escola}</td>
      <td>${atual.status}</td>
      <td>${atual.IPT.toFixed(2)}</td>
      <td><span class="badge ${classe}">${selo}</span></td>
      <td><canvas id="spark-${i}" width="120" height="40"></canvas></td>
    `;
    tbody.appendChild(tr);

    criarSparkline(`spark-${i}`, lista.map(l=>l.IPT));
  });
}

/* ================= SPARKLINE ================= */
function criarSparkline(id, dados){
  new Chart(document.getElementById(id),{
    type:"line",
    data:{
      labels:dados.map((_,i)=>i+1),
      datasets:[{
        data:dados,
        borderColor:"#1f4fd8",
        tension:.4,
        pointRadius:0
      }]
    },
    options:{
      responsive:false,
      plugins:{ legend:{display:false} },
      scales:{
        x:{display:false},
        y:{display:false}
      }
    }
  });
}

/* ================= HIST√ìRICO ================= */
window.abrirHistorico = function(){
  const box = document.getElementById("conteudoHistorico");
  box.innerHTML="";

  Object.values(cacheAvaliacoes).flat().sort((a,b)=>b._ts-a._ts)
  .forEach(d=>{
    box.innerHTML+=`
      <p>
        <strong>${d.escola}</strong><br>
        ${d.status} ‚Äî IPT ${d.IPT.toFixed(2)}<br>
        ${new Date(d._ts*1000).toLocaleDateString()}
      </p><hr>
    `;
  });

  modalHistorico.style.display="flex";
}

window.fecharHistorico = ()=> modalHistorico.style.display="none";

/* ================= XLSX (placeholder) ================= */
window.exportarXLSX = ()=> alert("Exporta√ß√£o XLSX mant√©m seu c√≥digo atual");

/* ================= INIT ================= */
carregar();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Painel Gerencial ‚Äì CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1f4fd8">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;display:flex;flex-direction:column;min-height:100vh}
.card{background:#fff;max-width:1100px;margin:20px auto;padding:20px;border-radius:10px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.kpi{background:#f9fafb;border-radius:10px;padding:16px}
.kpi h4{margin:0;font-size:14px;color:#555}
.kpi strong{font-size:30px;display:block;margin-top:6px}
.info{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#1f4fd8;color:#fff;font-size:12px;cursor:pointer;margin-left:6px}
.badge{padding:4px 8px;border-radius:12px;color:#fff;font-size:12px}
.adequada{background:#4caf50}
.alerta{background:yellow;color:#000}
.atencao{background:#ff7043}
.critica{background:#f44336}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #eee}
th{background:#f4f6f8;text-align:left}
button{padding:10px 14px;background:#1f4fd8;color:#fff;border:none;border-radius:6px;cursor:pointer}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:500px}
@media(max-width:600px){
.grid{grid-template-columns:1fr}
table thead{display:none}
table tr{display:block;margin-bottom:12px;border:1px solid #eee;border-radius:8px;padding:10px}
table td{display:block;border:none;padding:4px 0}
table td:nth-child(1)::before{content:"# "}
table td:nth-child(2)::before{content:"Escola "}
table td:nth-child(3)::before{content:"Status "}
table td:nth-child(4)::before{content:"IPT "}
}
</style>
</head>

<body>

<div class="card">
<h2>Painel Gerencial ‚Äì CheckInfra</h2>
<small>S√≠ntese executiva e prioriza√ß√£o t√©cnica</small>
</div>

<div class="card grid">
<div class="kpi"><h4>Unidades Cr√≠ticas</h4><strong id="kpiCritica">‚Äì</strong></div>
<div class="kpi"><h4>Unidades em Aten√ß√£o</h4><strong id="kpiAtencao">‚Äì</strong></div>
<div class="kpi"><h4>IPT M√©dio <span class="info" onclick="abrirModal()">i</span></h4><strong id="kpiMedio">‚Äì</strong></div>
</div>

<div class="card grid">
<div><h3>Status das Unidades</h3><canvas id="graficoStatus"></canvas></div>
<div><h3>Top Prioridades (IPT)</h3><canvas id="graficoIndice"></canvas></div>
</div>

<div class="card">
<h3>üèÜ Ranking Geral de Prioridade T√©cnica</h3>
<button onclick="exportarXLSX()">‚¨áÔ∏è Baixar XLSX</button><br><br>
<table>
<thead><tr><th>#</th><th>Escola</th><th>Status</th><th>IPT</th></tr></thead>
<tbody id="tabelaRanking"></tbody>
</table>
</div>

<div class="modal" id="modalIPT" onclick="fecharModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<h3>O que √© o IPT m√©dio?</h3>
<p>Expressa o grau m√©dio de urg√™ncia t√©cnica da rede escolar.</p>
<button onclick="fecharModal()">Fechar</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain:"checkinfra-adf3c.firebaseapp.com",
  projectId:"checkinfra-adf3c"
});

const db = getFirestore(app);

let rankingGlobal=[];

async function carregarAvaliacoes(){
  const snap=await getDocs(collection(db,"avaliacoes"));
  const porEscola={};

  snap.forEach(doc=>{
    const d=doc.data();
    if(!d.escola||!d.status) return;

    if(!porEscola[d.escola]){
      porEscola[d.escola]=d;
    }else{
      const atual=porEscola[d.escola];
      if(d.createdAt?.seconds > atual.createdAt?.seconds){
        porEscola[d.escola]=d;
      }
    }
  });

  montar(Object.values(porEscola));
}

function montar(dados){
  const tabela=document.getElementById("tabelaRanking");
  tabela.innerHTML="";
  rankingGlobal=[];
  let critica=0,atencao=0,soma=0;
  const statusCount={adequada:0,alerta:0,atencao:0,critica:0};

  dados.forEach(d=>{
    let GS=1,classe="adequada";
    const s=d.status.toLowerCase();

    if(s.includes("cr√≠t")){GS=4;classe="critica";critica++;statusCount.critica++}
    else if(s.includes("aten")){GS=3;classe="atencao";atencao++;statusCount.atencao++}
    else if(s.includes("alert")){GS=2;classe="alerta";statusCount.alerta++}
    else statusCount.adequada++;

    const IT=Number(d.pontuacao||0);
    const RT=Number(d.rt||0);
    const IPT=(GS*0.4)+(IT*0.4)+(RT*0.2);
    soma+=IPT;

    rankingGlobal.push({
      escola:d.escola,
      classe,
      statusLabel:d.status,
      IPT
    });
  });

  rankingGlobal.sort((a,b)=>b.IPT-a.IPT);

  rankingGlobal.forEach((r,i)=>{
    tabela.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${r.escola}</td>
      <td><span class="badge ${r.classe}">${r.statusLabel}</span></td>
      <td>${r.IPT.toFixed(2)}</td>
    </tr>`;
  });

  document.getElementById("kpiCritica").innerText=critica;
  document.getElementById("kpiAtencao").innerText=atencao;
  document.getElementById("kpiMedio").innerText=(soma/dados.length).toFixed(2);

  new Chart(graficoStatus,{type:"pie",data:{labels:["Adequada","Alerta","Aten√ß√£o","Cr√≠tica"],datasets:[{data:Object.values(statusCount),backgroundColor:["#4caf50","yellow","#ff7043","#f44336"]}]}});
  new Chart(graficoIndice,{type:"bar",data:{labels:rankingGlobal.slice(0,10).map(r=>r.escola),datasets:[{data:rankingGlobal.slice(0,10).map(r=>r.IPT.toFixed(2)),backgroundColor:"#1f4fd8"}]},options:{indexAxis:"y",plugins:{legend:{display:false}}}});
}

window.exportarXLSX=function(){
  const ws=XLSX.utils.json_to_sheet(rankingGlobal.map(r=>({Escola:r.escola,Status:r.statusLabel,IPT:r.IPT.toFixed(2)})));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Ranking IPT");
  XLSX.writeFile(wb,"ranking_checkinfra.xlsx");
}

window.abrirModal=()=>modalIPT.style.display="flex";
window.fecharModal=()=>modalIPT.style.display="none";

carregarAvaliacoes();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Painel da Secretaria</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { background:#fff; max-width:1100px; margin:20px auto; padding:20px; border-radius:8px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
h2 { margin:0 0 10px; }
small { color:#666; }
.grafico { max-width:500px; margin:auto; }
</style>
</head>
<body>

<div class="card">
  <h2>Painel da Secretaria</h2>
  <small>Dados consolidados das avaliações sanitárias</small>
</div>

<div class="card grid">
  <div>
    <h3>Status das Avaliações</h3>
    <div class="grafico">
      <canvas id="graficoStatus"></canvas>
    </div>
  </div>

  <div>
    <h3>Principais Problemas (estimativa técnica)</h3>
    <canvas id="graficoProblemas"></canvas>
  </div>
</div>

<div class="card">
  <h3>Dias em Situação Crítica</h3>
  <canvas id="graficoTempo"></canvas>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwdAy2jS1QhXKC4qaJwnlmEx_mM2tDX1lxbcVrInyngBrC6ICBHONlTfRsZ9q6aWGPB/exec";

fetch(SCRIPT_URL)
  .then(r => r.json())
  .then(dados => montarGraficos(dados))
  .catch(() => alert("Erro ao carregar dados do painel"));

function montarGraficos(dados) {

  /* ===== STATUS ===== */
  const statusCount = { adequada:0, alerta:0, critica:0 };

  dados.forEach(d => {
    const s = (d.status || "").toLowerCase();
    if (s.includes("crítica")) statusCount.critica++;
    else if (s.includes("alerta")) statusCount.alerta++;
    else statusCount.adequada++;
  });

  new Chart(graficoStatus, {
    type: "pie",
    data: {
      labels: ["Adequada","Alerta","Crítica"],
      datasets: [{
        data: [
          statusCount.adequada,
          statusCount.alerta,
          statusCount.critica
        ],
        backgroundColor: ["#4caf50","#ff9800","#f44336"]
      }]
    }
  });

  /* ===== PRINCIPAIS PROBLEMAS (DERIVADOS) ===== */
  const problemasCount = {
    "Problemas estruturais graves": 0,
    "Problemas sanitários recorrentes": 0
  };

  dados.forEach(d => {
    const p = Number(d.pontuacao || 0);
    if (p >= 9) problemasCount["Problemas estruturais graves"]++;
    else if (p >= 4) problemasCount["Problemas sanitários recorrentes"]++;
  });

  new Chart(graficoProblemas, {
    type: "bar",
    data: {
      labels: Object.keys(problemasCount),
      datasets: [{
        label: "Ocorrências",
        data: Object.values(problemasCount),
        backgroundColor: "#1f4fd8"
      }]
    },
    options: {
      indexAxis: "y",
      scales: { x: { beginAtZero: true } }
    }
  });

  /* ===== CRÍTICOS POR DIA ===== */
  const porDia = {};

  dados.forEach(d => {
    if (!d.timestamp || !d.status) return;
    if (!d.status.toLowerCase().includes("crítica")) return;
    const dia = d.timestamp.toString().split("T")[0];
    porDia[dia] = (porDia[dia] || 0) + 1;
  });

  new Chart(graficoTempo, {
    type: "line",
    data: {
      labels: Object.keys(porDia),
      datasets: [{
        label: "Registros críticos",
        data: Object.values(porDia),
        borderColor: "#f44336",
        fill: false
      }]
    }
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel • CheckInfra</title>

<!-- Firebase (compat – igual ao que funcionou) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js (VERSÃO CORRETA SEM MODULE) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#f5f6f7;
  color:#222;
}

/* HEADER */
header{
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center;
  padding:12px 16px;
  background:#0d3b66;
  color:#fff;
}
header h1{font-size:1.1rem;text-align:center}
header button{
  background:none;
  border:none;
  color:#fff;
  font-size:1.4rem;
  cursor:pointer;
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  top:0;
  right:-260px;
  width:260px;
  height:100%;
  background:#0d3b66;
  padding:20px;
  transition:.3s;
  z-index:1000;
}
.sidebar.open{right:0}
.sidebar a{
  display:block;
  color:#fff;
  text-decoration:none;
  padding:12px 0;
  font-weight:500;
}

/* MAIN */
main{padding:16px}
section{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin-bottom:32px;
}

/* GRAFICOS */
.graficos{
  display:flex;
  flex-direction:column;
  gap:32px;
}
canvas{width:100%!important;height:auto!important}

/* BOTOES */
.btn{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#0d3b66;
  color:#fff;
  cursor:pointer;
  margin-top:8px;
}

/* FOOTER */
footer{
  text-align:center;
  font-size:.85rem;
  padding:16px;
  color:#555;
}
footer a{color:#0d3b66;text-decoration:none;margin:0 6px}
</style>
</head>

<body>

<header>
  <button onclick="history.back()">←</button>
  <h1>Painel CheckInfra</h1>
  <button onclick="abrirSidebar()">☰</button>
</header>

<aside id="sidebar" class="sidebar">
  <a href="metodo.html">Metodologia</a>
</aside>

<main>

<section>
  <h2>Ranking IPT</h2>
  <button class="btn" onclick="exportarRankingXLSX()">Baixar XLSX</button>
  <div class="graficos">
    <canvas id="graficoRanking"></canvas>
  </div>
</section>

<section>
  <h2>Problemas mais recorrentes</h2>
  <div class="graficos">
    <canvas id="graficoProblemas"></canvas>
  </div>
</section>

<section>
  <h2>Histórico de Avaliações</h2>
  <button class="btn" onclick="exportarHistoricoXLSX()">Baixar XLSX</button>
  <div class="graficos">
    <canvas id="graficoHistorico"></canvas>
  </div>
</section>

</main>

<footer>
  <a href="/pages/sobre.html">Sobre</a> |
  <a href="/pages/contato.html">Contato</a> |
  <a href="/pages/termos.html">Termos</a>
</footer>

<script>
/* SIDEBAR */
function abrirSidebar(){
  document.getElementById("sidebar").classList.toggle("open");
}

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain:"checkinfra-adf3c.firebaseapp.com",
  projectId:"checkinfra-adf3c"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* DADOS GLOBAIS */
let dadosRanking=[];
let dadosHistorico=[];

/* CARREGAR */
async function carregarAvaliacoes(){
  const snap=await db.collection("avaliacoes").get();
  const problemas={};

  snap.forEach(doc=>{
    const d=doc.data();
    dadosHistorico.push(d);
    dadosRanking.push({escola:d.escola,pontuacao:d.pontuacao});

    (d.problemas||[]).forEach(p=>{
      problemas[p]=(problemas[p]||0)+1;
    });
  });

  montarRanking();
  montarProblemas(problemas);
  montarHistorico();
}

/* GRAFICOS */
function montarRanking(){
  dadosRanking.sort((a,b)=>b.pontuacao-a.pontuacao);
  new Chart(graficoRanking,{
    type:"bar",
    data:{
      labels:dadosRanking.map(d=>d.escola),
      datasets:[{data:dadosRanking.map(d=>d.pontuacao)}]
    },
    options:{
      indexAxis:"y",
      scales:{
        y:{
          ticks:{
            callback:(v,i)=>dadosRanking[i].escola.slice(0,25)
          }
        }
      }
    }
  });
}

function montarProblemas(p){
  new Chart(graficoProblemas,{
    type:"bar",
    data:{
      labels:Object.keys(p),
      datasets:[{data:Object.values(p)}]
    }
  });
}

function montarHistorico(){
  new Chart(graficoHistorico,{
    type:"line",
    data:{
      labels:dadosHistorico.map(d=>d.id),
      datasets:[{data:dadosHistorico.map(d=>d.pontuacao)}]
    }
  });
}

/* XLSX */
function exportarRankingXLSX(){
  const ws=XLSX.utils.json_to_sheet(dadosRanking);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Ranking");
  XLSX.writeFile(wb,"ranking.xlsx");
}
function exportarHistoricoXLSX(){
  const ws=XLSX.utils.json_to_sheet(dadosHistorico);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Historico");
  XLSX.writeFile(wb,"historico.xlsx");
}

carregarAvaliacoes();
</script>

</body>
</html>
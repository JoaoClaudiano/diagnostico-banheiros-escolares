<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">

<!-- Google tag -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD4SQ88NVT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DD4SQ88NVT');
</script>

<title>An√°lise Espacial ‚Äì CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1f4fd8">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- üî• PLUGIN HEATMAP -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1f4fd8;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}

#map { height: calc(100vh - 190px); }

.painel {
  padding:10px;
  background:#f4f6f8;
  display:flex;
  gap:15px;
  justify-content:center;
  font-size:14px;
  flex-wrap:wrap;
}

.painel label {
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
}

.bola {
  width:12px;
  height:12px;
  border-radius:50%;
  display:inline-block;
}
.verde { background:green; }
.laranja { background:orange; }
.vermelho { background:red; }

/* ===== PULSO ===== */
.pulse-critico { animation: pulse-red 2.4s ease-out infinite; }
.pulse-alerta  { animation: pulse-orange 2.4s ease-out infinite; }
.pulse-adequado{ animation: pulse-green 2.4s ease-out infinite; }

@keyframes pulse-red {
  0% { r:8; opacity:.9; }
  70% { r:18; opacity:0; }
  100% { opacity:0; }
}
@keyframes pulse-orange {
  0% { r:8; opacity:.8; }
  70% { r:16; opacity:0; }
  100% { opacity:0; }
}
@keyframes pulse-green {
  0% { r:8; opacity:.7; }
  70% { r:14; opacity:0; }
  100% { opacity:0; }
}

/* ===== LEGENDA ===== */
.legenda {
  background:#fff;
  padding:10px;
  font-size:13px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}
.legenda h4 {
  margin:0 0 6px;
  font-size:14px;
}
.legenda div {
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
</style>
</head>

<body>

<header>
  An√°lise Espacial ‚Äì Leitura Territorial Explorat√≥ria
  <div style="font-size:12px;font-weight:normal;opacity:.9;">
    Identifica√ß√£o de padr√µes espaciais relativos √†s condi√ß√µes sanit√°rias das escolas
  </div>
</header>

<div style="padding:10px;font-size:13px;background:#f8f9fa;border-bottom:1px solid #ddd;text-align:center;">
  Esta visualiza√ß√£o apresenta <strong>padr√µes espaciais relativos</strong>.
  As an√°lises s√£o explorat√≥rias e n√£o indicam causalidade,
  nem substituem vistorias t√©cnicas presenciais.
</div>

<div class="painel">
  <label>
    <input type="checkbox" id="toggleHeatmap" checked>
    üî• Heatmap (concentra√ß√£o territorial)
  </label>

  <label>
    <input type="checkbox" id="togglePontos">
    ‚¨§ Escolas (pontos)
  </label>

  <label>
    <input type="checkbox" id="togglePulso" checked>
    üåê Mapa vivo
  </label>
</div>

<div id="map"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyt4wD8LQ67NOD-Zz7EEvfc7RuYEhKDYE50gkK7rp-47idg6STKUGqk5pYVDclamentdQ/exec";

const map = L.map("map").setView([-3.7319, -38.5267], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

// Camadas
const camadaAdequado = L.layerGroup();
const camadaAlerta = L.layerGroup();
const camadaCritico = L.layerGroup();

let pulsoAtivo = true;
let dadosHeatmap = [];

const camadaHeatmap = L.heatLayer(dadosHeatmap, {
  radius: 30,
  blur: 20,
  maxZoom: 17
});

function camadaPorStatus(status) {
  if (status.includes("cr√≠tica")) return camadaCritico;
  if (status.includes("alerta")) return camadaAlerta;
  return camadaAdequado;
}
function corPorStatus(status) {
  if (status.includes("cr√≠tica")) return "red";
  if (status.includes("alerta")) return "orange";
  return "green";
}
function classePulso(status) {
  if (!pulsoAtivo) return "";
  if (status.includes("cr√≠tica")) return "pulse-critico";
  if (status.includes("alerta")) return "pulse-alerta";
  return "pulse-adequado";
}

fetch(API_URL)
  .then(res => res.json())
  .then(dados => {
    dados.forEach(e => {
      if (!e.lat || !e.lng) return;

      dadosHeatmap.push([e.lat, e.lng, 1]);

      L.circleMarker([e.lat, e.lng], {
        radius:8,
        color: corPorStatus(e.status),
        fillColor: corPorStatus(e.status),
        fillOpacity:.8,
        className: classePulso(e.status)
      })
      .bindPopup(`
        <strong>${e.escola}</strong><br>
        Status: ${e.status}<br>
        Pontua√ß√£o: ${e.pontuacao}
      `)
      .addTo(camadaPorStatus(e.status));
    });

    camadaHeatmap.addTo(map);
  });

// Controles
document.getElementById("toggleHeatmap").addEventListener("change", e => {
  e.target.checked ? map.addLayer(camadaHeatmap) : map.removeLayer(camadaHeatmap);
});

document.getElementById("togglePontos").addEventListener("change", e => {
  if (e.target.checked) {
    map.addLayer(camadaAdequado);
    map.addLayer(camadaAlerta);
    map.addLayer(camadaCritico);
  } else {
    map.removeLayer(camadaAdequado);
    map.removeLayer(camadaAlerta);
    map.removeLayer(camadaCritico);
  }
});

document.getElementById("togglePulso").addEventListener("change", e => {
  pulsoAtivo = e.target.checked;
  location.reload();
});

// Legenda
const legenda = L.control({ position: "bottomright" });
legenda.onAdd = function () {
  const div = L.DomUtil.create("div", "legenda");
  div.innerHTML = `
    <h4>Leitura do mapa</h4>
    <div><span class="bola verde"></span> Situa√ß√£o adequada</div>
    <div><span class="bola laranja"></span> Requer aten√ß√£o</div>
    <div><span class="bola vermelho"></span> Prioridade de interven√ß√£o</div>
    <hr>
    <small>
      Heatmap indica concentra√ß√£o territorial relativa.
      N√£o substitui inspe√ß√£o t√©cnica presencial.
    </small>
  `;
  return div;
};
legenda.addTo(map);
</script>

</body>
</html>

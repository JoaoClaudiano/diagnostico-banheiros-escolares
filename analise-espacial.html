<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">

<title>AnÃ¡lise Espacial â€“ CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1f4fd8">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1f4fd8;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}

#map { height: calc(100vh - 210px); }

.painel {
  padding:10px;
  background:#f4f6f8;
  display:flex;
  gap:12px;
  justify-content:center;
  font-size:14px;
  flex-wrap:wrap;
}

.painel select, .painel label {
  display:flex;
  align-items:center;
  gap:6px;
}

.legenda {
  background:#fff;
  padding:10px;
  font-size:13px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}
</style>
</head>

<body>

<header>
  ðŸ§­ AnÃ¡lise Espacial â€“ Leitura Territorial ExploratÃ³ria
  <div style="font-size:12px;font-weight:normal;opacity:.9;">
    Indicadores espaciais relativos Ã s condiÃ§Ãµes sanitÃ¡rias das escolas
  </div>
</header>

<div style="padding:10px;font-size:13px;background:#f8f9fa;border-bottom:1px solid #ddd;text-align:center;">
  VisualizaÃ§Ãµes exploratÃ³rias. NÃ£o indicam causalidade nem substituem vistorias tÃ©cnicas presenciais.
</div>

<div class="painel">
  <label>
    Indicador:
    <select id="seletorIndicador">
      <option value="1">Indicador 1 â€” Densidade CrÃ­tica</option>
      <option value="2">Indicador 2 â€” ConcentraÃ§Ã£o Relativa</option>
    </select>
  </label>

  <label>
    <input type="checkbox" id="toggleZonas" checked>
    ðŸŸ¥ Zonas prioritÃ¡rias
  </label>
</div>

<div id="map"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyt4wD8LQ67NOD-Zz7EEvfc7RuYEhKDYE50gkK7rp-47idg6STKUGqk5pYVDclamentdQ/exec";

const map = L.map("map").setView([-3.7319, -38.5267], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let modoIndicador = 1;
let dadosHeatmap = [];

const camadaHeatmap = L.heatLayer(dadosHeatmap, {
  radius: 35,
  blur: 25,
  maxZoom: 18,
  minOpacity: 0.35
}).addTo(map);

const camadaZonas = L.layerGroup().addTo(map);

// ðŸ”„ AdaptaÃ§Ã£o ao zoom
function atualizarHeatmapPorZoom() {
  const zoom = map.getZoom();
  let raio = 35;

  if (zoom <= 11) raio = 60;
  else if (zoom <= 13) raio = 45;
  else if (zoom <= 15) raio = 30;
  else raio = 20;

  camadaHeatmap.setOptions({ radius: raio });
}
map.on("zoomend", atualizarHeatmapPorZoom);

// ðŸ” Recalcular tudo
function recalcularMapa(dados) {
  dadosHeatmap.length = 0;
  camadaZonas.clearLayers();

  dados.forEach(e => {
    if (!e.lat || !e.lng) return;

    let peso = 0.3;

    if (modoIndicador === 1) {
      if (e.status.includes("crÃ­tica")) peso = 1.5;
      else if (e.status.includes("alerta")) peso = 1.0;
    }

    if (modoIndicador === 2) {
      if (e.status.includes("crÃ­tica")) peso = 1.2;
      else if (e.status.includes("alerta")) peso = 0.8;
    }

    dadosHeatmap.push([e.lat, e.lng, peso]);

    // Zona prioritÃ¡ria simples
    if (peso >= 1.2) {
      L.circle([e.lat, e.lng], {
        radius: 500,
        color: "red",
        fillColor: "red",
        fillOpacity: 0.08,
        weight: 1
      }).addTo(camadaZonas);
    }
  });

  camadaHeatmap.setLatLngs(dadosHeatmap);
}

// ðŸ”„ Carregar dados
fetch(API_URL)
  .then(res => res.json())
  .then(dados => {
    recalcularMapa(dados);

    document.getElementById("seletorIndicador").addEventListener("change", e => {
      modoIndicador = Number(e.target.value);
      recalcularMapa(dados);
    });
  });

// Toggle zonas
document.getElementById("toggleZonas").addEventListener("change", e => {
  e.target.checked ? map.addLayer(camadaZonas) : map.removeLayer(camadaZonas);
});

// Legenda
const legenda = L.control({ position: "bottomright" });
legenda.onAdd = function () {
  const div = L.DomUtil.create("div", "legenda");
  div.innerHTML = `
    <strong>Indicadores</strong><br>
    ðŸ”¥ Intensidade = concentraÃ§Ã£o territorial<br>
    ðŸŸ¥ Zonas = Ã¡reas prioritÃ¡rias<br><br>
    <small>Leitura exploratÃ³ria.</small>
  `;
  return div;
};
legenda.addTo(map);
</script>

</body>
</html>

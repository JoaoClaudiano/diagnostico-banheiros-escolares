<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">

<title>An√°lise Espacial ‚Äì CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1f4fd8">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>CheckInfra ‚Äî An√°lise Espacial Priorit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  color: #333;
  line-height: 1.6;
}

main {
  max-width: 900px;
  margin: 30px auto;
  padding: 0 20px;
}

h1, h2 {
  color: #1f4fd8;
}

.card {
  background: #fff;
  border-radius: 14px;
  padding: 26px;
  margin-bottom: 26px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.accordion-item {
  border-top: 1px solid #e0e0e0;
  margin-top: 12px;
}

.accordion-header {
  width: 100%;
  background: none;
  border: none;
  padding: 14px 0;
  font-size: 16px;
  font-weight: bold;
  color: #1f4fd8;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  text-align: left;
}

.accordion-header span {
  font-size: 20px;
  transition: transform 0.3s ease;
}

.accordion-header.active span {
  transform: rotate(90deg);
}

.accordion-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease;
}

.accordion-content p,
.accordion-content ul {
  margin: 10px 0;
}

.info {
  font-size: 13px;
  color: #555;
}

@media (max-width: 600px) {
  .accordion-header {
    font-size: 15px;
  }
}
</style>
</head>

<body>

<main>

<div class="card">
<h1>An√°lise Espacial Priorit√°ria ‚Äî CheckInfra</h1>
<p>
Esta se√ß√£o apresenta como o <strong>Princ√≠pio de Pareto</strong> √© aplicado
√† an√°lise espacial, em conjunto com <strong>densidade cr√≠tica</strong> e
<strong>concentra√ß√£o relativa</strong>, para defini√ß√£o de zonas priorit√°rias
de interven√ß√£o.
</p>

<!-- ABA 1 -->
<div class="accordion-item">
<button class="accordion-header">
1. Princ√≠pio de Pareto aplicado ao territ√≥rio
<span>‚Ä∫</span>
</button>
<div class="accordion-content">
<p>
O Princ√≠pio de Pareto indica que uma pequena parcela das causas
costuma concentrar a maior parte dos efeitos.
</p>
<p>
No contexto territorial, isso significa que <strong>poucos territ√≥rios
concentram a maior parte da criticidade sanit√°ria da rede</strong>.
</p>
<p>
No CheckInfra, o Pareto √© aplicado sobre indicadores t√©cnicos
(IPT, pontua√ß√£o cr√≠tica ou n√∫mero de unidades cr√≠ticas),
ordenando os territ√≥rios do maior para o menor impacto.
</p>
<p class="info">
‚ÑπÔ∏è Refer√™ncias: Juran (1992), Montgomery (2019)
</p>
</div>
</div>

<!-- ABA 2 -->
<div class="accordion-item">
<button class="accordion-header">
2. Crit√©rios de corte (70%, 75% e 80%)
<span>‚Ä∫</span>
</button>
<div class="accordion-content">
<p>
Para evitar arbitrariedade, o CheckInfra utiliza
<strong>faixas de corte progressivas</strong> do Pareto:
</p>
<ul>
<li><strong>70%</strong> ‚Äî n√∫cleo cr√≠tico (prioridade imediata)</li>
<li><strong>75%</strong> ‚Äî prioridade estrat√©gica</li>
<li><strong>80%</strong> ‚Äî prioridade ampliada (Pareto cl√°ssico)</li>
</ul>
<p>
Esses cortes permitem adaptar decis√µes √† disponibilidade
or√ßament√°ria e ao horizonte temporal da pol√≠tica p√∫blica.
</p>
</div>
</div>

<!-- ABA 3 -->
<div class="accordion-item">
<button class="accordion-header">
3. Densidade cr√≠tica
<span>‚Ä∫</span>
</button>
<div class="accordion-content">
<p>
A densidade cr√≠tica mede a <strong>intensidade espacial</strong> dos problemas,
indicando quantas unidades cr√≠ticas existem em uma determinada √°rea.
</p>
<p>
Ela permite identificar <strong>bols√µes territoriais de fragilidade</strong>,
onde interven√ß√µes integradas tendem a ser mais eficientes.
</p>
<p class="info">
‚ÑπÔ∏è Base conceitual: an√°lise espacial, sa√∫de p√∫blica, planejamento urbano
</p>
</div>
</div>

<!-- ABA 4 -->
<div class="accordion-item">
<button class="accordion-header">
4. Concentra√ß√£o relativa
<span>‚Ä∫</span>
</button>
<div class="accordion-content">
<p>
A concentra√ß√£o relativa compara a propor√ß√£o de unidades cr√≠ticas
de um territ√≥rio com a m√©dia da cidade.
</p>
<p>
Valores acima de 1 indicam que o territ√≥rio est√°
<strong>desproporcionalmente mais afetado</strong>,
evidenciando desigualdade territorial.
</p>
</div>
</div>

<!-- ABA 5 -->
<div class="accordion-item">
<button class="accordion-header">
5. Zonas priorit√°rias integradas
<span>‚Ä∫</span>
</button>
<div class="accordion-content">
<p>
Um territ√≥rio √© classificado como <strong>Zona Priorit√°ria</strong> quando:
</p>
<ul>
<li>est√° dentro do corte de Pareto</li>
<li>apresenta alta densidade cr√≠tica</li>
<li>possui concentra√ß√£o relativa acima da m√©dia</li>
</ul>
<p>
Essa integra√ß√£o evita decis√µes baseadas em um √∫nico indicador
e fortalece a justi√ßa t√©cnica da prioriza√ß√£o.
</p>
</div>
</div>

</div>

</main>

<script>
const headers = document.querySelectorAll(".accordion-header");

headers.forEach(header => {
  header.addEventListener("click", () => {
    const content = header.nextElementSibling;
    const isOpen = header.classList.contains("active");

    headers.forEach(h => {
      h.classList.remove("active");
      h.nextElementSibling.style.maxHeight = null;
    });

    if (!isOpen) {
      header.classList.add("active");
      content.style.maxHeight = content.scrollHeight + "px";
    }
  });
});
</script>

</body>
</html>
<style>
body { margin:0; font-family: Arial, sans-serif; }
.nav-global {
  position: fixed;
  top: 12px;
  left: 12px;
  display: flex;
  gap: 8px;
  z-index: 9999;
}

.nav-global button,
.nav-global a {
  background: rgba(31,79,216,0.95);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.nav-global button:hover,
.nav-global a:hover {
  background: #163aa9;
}
header {
  background:#1f4fd8;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}

#map { height: calc(100vh - 260px); }

.painel {
  padding:10px;
  background:#f4f6f8;
  display:flex;
  gap:12px;
  justify-content:center;
  font-size:14px;
  flex-wrap:wrap;
}

.painel select, .painel label {
  display:flex;
  align-items:center;
  gap:6px;
}

.abas {
  display:flex;
  justify-content:center;
  background:#e9ecef;
  border-bottom:1px solid #ccc;
}

.abas button {
  padding:10px 16px;
  border:none;
  background:none;
  cursor:pointer;
  font-weight:bold;
}

.abas button.ativa {
  background:#fff;
  border-bottom:3px solid #1f4fd8;
}

.secao { display:none; }
.secao.ativa { display:block; }

.legenda {
  background:#fff;
  padding:10px;
  font-size:13px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}

#ranking {
  padding:12px;
  font-size:14px;
}

#metodologia {
  padding:16px;
  font-size:14px;
  line-height:1.6;
}
</style>
</head>

<body>
<div class="nav-global">
  <button onclick="history.back()" title="Voltar">
    ‚¨ÖÔ∏è
  </button>

  <a href="./index.html" title="In√≠cio">
    üè†
  </a>
</div>
<header>
  üß≠ An√°lise Espacial ‚Äì Leitura Territorial Explorat√≥ria
  <div style="font-size:12px;font-weight:normal;opacity:.9;">
    Indicadores espaciais relativos √†s condi√ß√µes sanit√°rias das escolas
  </div>
</header>

<div class="abas">
  <button class="ativa" onclick="abrirAba('mapa')">üó∫Ô∏è Mapa</button>
  <button onclick="abrirAba('ranking')">üìä Ranking</button>
  <button onclick="abrirAba('metodologia')">üìò Metodologia</button>
</div>

<!-- ===== MAPA ===== -->
<div id="mapa" class="secao ativa">

  <div class="painel">
    <label>
      Indicador:
      <select id="seletorIndicador">
        <option value="1">Indicador 1 ‚Äî Densidade Cr√≠tica</option>
        <option value="2">Indicador 2 ‚Äî Concentra√ß√£o Relativa</option>
      </select>
    </label>

    <label>
      <input type="checkbox" id="toggleZonas" checked>
      üü• Zonas priorit√°rias
    </label>
  </div>

  <div id="map"></div>
</div>

<!-- ===== RANKING ===== -->
<div id="ranking" class="secao">
  <h3>üìä Ranking Territorial ‚Äî Zonas Priorit√°rias</h3>
  <ol id="listaRanking"></ol>
</div>

<!-- ===== METODOLOGIA ===== -->
<div id="metodologia" class="secao">
  <h3>üìò Metodologia e Indicadores</h3>

  <p>
    Esta an√°lise utiliza <strong>unidades territoriais regulares</strong>
    (c√©lulas espaciais de aproximadamente 1 km¬≤) para identificar padr√µes
    de concentra√ß√£o relativa das condi√ß√µes sanit√°rias das escolas.
  </p>

  <h4>Indicadores</h4>
  <ul>
    <li><strong>Indicador 1 ‚Äì Densidade Cr√≠tica:</strong> enfatiza a presen√ßa absoluta de escolas em situa√ß√£o cr√≠tica.</li>
    <li><strong>Indicador 2 ‚Äì Concentra√ß√£o Relativa:</strong> pondera criticidade e alerta de forma equilibrada.</li>
  </ul>

  <h4>√çndice Territorial (0‚Äì100)</h4>
  <p>
    O √≠ndice territorial representa a intensidade relativa da condi√ß√£o sanit√°ria
    em cada c√©lula, normalizada em uma escala de 0 a 100, permitindo compara√ß√£o
    entre √°reas.
  </p>

  <p><em>
    As an√°lises s√£o explorat√≥rias e n√£o substituem vistorias t√©cnicas presenciais.
  </em></p>
</div>

<script>
/* =====================
   ABAS
===================== */
function abrirAba(id) {
  document.querySelectorAll(".secao").forEach(s => s.classList.remove("ativa"));
  document.querySelectorAll(".abas button").forEach(b => b.classList.remove("ativa"));
  document.getElementById(id).classList.add("ativa");
  event.target.classList.add("ativa");
}

/* =====================
   MAPA E DADOS
===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbyt4wD8LQ67NOD-Zz7EEvfc7RuYEhKDYE50gkK7rp-47idg6STKUGqk5pYVDclamentdQ/exec";

const map = L.map("map").setView([-3.7319, -38.5267], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

let modoIndicador = 1;
let dadosOriginais = [];

const camadaHeatmap = L.heatLayer([], {
  radius: 35, blur: 25, minOpacity: 0.35
}).addTo(map);

const camadaZonas = L.layerGroup().addTo(map);

/* =====================
   GRID
===================== */
function gerarGrid(bounds, tamanho) {
  const grid = [];
  for (let lat = bounds.getSouth(); lat < bounds.getNorth(); lat += tamanho) {
    for (let lng = bounds.getWest(); lng < bounds.getEast(); lng += tamanho) {
      grid.push({ bounds: [[lat,lng],[lat+tamanho,lng+tamanho]], peso:0 });
    }
  }
  return grid;
}

/* =====================
   RECALCULAR
===================== */
function recalcularMapa(dados) {
  camadaZonas.clearLayers();
  camadaHeatmap.setLatLngs([]);

  const grid = gerarGrid(map.getBounds(), 0.01);
  let maxPeso = 0;

  dados.forEach(e => {
    if (!e.lat || !e.lng) return;

    let peso = 0.3;
    if (modoIndicador === 1) peso = e.status.includes("cr√≠tica") ? 1.5 : e.status.includes("alerta") ? 1.0 : 0.3;
    if (modoIndicador === 2) peso = e.status.includes("cr√≠tica") ? 1.2 : e.status.includes("alerta") ? 0.8 : 0.3;

    camadaHeatmap.addLatLng([e.lat, e.lng, peso]);

    grid.forEach(c => {
      const [[a,b],[c2,d]] = c.bounds;
      if (e.lat>=a && e.lat<c2 && e.lng>=b && e.lng<d) c.peso += peso;
      maxPeso = Math.max(maxPeso, c.peso);
    });
  });

  const ranking = grid
    .filter(c => c.peso > 0)
    .sort((a,b) => b.peso - a.peso)
    .slice(0,5);

  const lista = document.getElementById("listaRanking");
  lista.innerHTML = "";

  ranking.forEach((c,i) => {
    const indice = Math.round((c.peso / maxPeso) * 100);

    lista.innerHTML += `<li>Zona ${i+1} ‚Äî √çndice Territorial: ${indice}</li>`;

    L.rectangle(c.bounds,{
      color:"#de2d26", fillOpacity:0.4, weight:1
    }).addTo(camadaZonas);
  });
}

/* =====================
   EVENTOS
===================== */
fetch(API_URL).then(r=>r.json()).then(d=>{
  dadosOriginais = d;
  recalcularMapa(dadosOriginais);
});

document.getElementById("seletorIndicador").addEventListener("change",e=>{
  modoIndicador = Number(e.target.value);
  recalcularMapa(dadosOriginais);
});

document.getElementById("toggleZonas").addEventListener("change",e=>{
  e.target.checked ? map.addLayer(camadaZonas) : map.removeLayer(camadaZonas);
});
</script>

</body>
</html>

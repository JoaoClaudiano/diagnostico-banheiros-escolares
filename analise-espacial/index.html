<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>AnÃ¡lise Espacial â€“ CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="estilo.css">
</head>
<body>
  
<script src="debug-dados.js"></script>

<header>
  <button id="btn-voltar" style="position:absolute;left:16px;top:16px;padding:6px 12px;cursor:pointer;">â¬…ï¸ Voltar</button>
  <div style="text-align:center;">
    ğŸ§­ AnÃ¡lise Espacial â€“ Leitura Territorial ExploratÃ³ria
    <div style="font-size:12px;font-weight:normal;opacity:.9;">
      Indicadores espaciais relativos Ã s condiÃ§Ãµes sanitÃ¡rias das escolas
    </div>
  </div>
  <button id="btn-sidebar" style="position:absolute;right:16px;top:16px;padding:6px 12px;cursor:pointer;">ğŸ“‘ Indicadores</button>
</header>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <button id="close-sidebar" aria-label="Fechar">âœ•</button>
  <nav id="sidebar-menu">
    <ul>
      <li data-indicador="pareto" class="ativa">ğŸ“Š Pareto</li>
      <li data-indicador="densidade-critica">ğŸ“ Densidade CrÃ­tica</li>
      <li data-indicador="concentracao-relativa">ğŸ“ˆ ConcentraÃ§Ã£o Relativa</li>
      <li data-indicador="zonas-prioritarias">ğŸŸ¥ Zonas PrioritÃ¡rias</li>
      <!-- NOVOS INDICADORES ADICIONADOS -->
      <li data-indicador="kde">ğŸ”¥ KDE</li>
      <li data-indicador="gini">âš–ï¸ Gini Espacial</li>
      <li data-indicador="lq">ğŸ“ˆ Location Quotient</li>
      <li data-indicador="moran">ğŸ”— Ãndice de Moran</li>
    </ul>
  </nav>
  <div id="sidebar-content"></div>
</div>

<div class="abas">
  <button class="ativa" onclick="abrirAba('mapa')">ğŸ—ºï¸ Mapa</button>
  <button onclick="abrirAba('ranking')">ğŸ“Š Ranking</button>
  <button onclick="abrirAba('metodologia')">ğŸ“˜ Metodologia</button>
  <button onclick="abrirAba('avancada')">ğŸš€ AnÃ¡lise AvanÃ§ada</button>
  <button onclick="abrirAba('dados')">ğŸ“Š Dashboard de Dados</button>
</div>

<!-- DASHBOARD DE DADOS -->
<div id="dados" class="secao">
  <h3>ğŸ“Š Dashboard de Dados em Tempo Real</h3>
  <div id="dashboard-dados"></div>
  
  <div class="dados-detalhes">
    <div class="dados-coluna">
      <h4>ğŸ“¡ ConexÃ£o de Dados</h4>
      <div class="conexao-status" id="conexao-status">
        <p>ğŸ”„ Verificando conexÃµes...</p>
      </div>
      
      <h4>ğŸ“‚ Fontes de Dados</h4>
      <ul id="fontes-dados">
        <li>Escolas locais: <span id="contador-local">carregando...</span></li>
        <li>AvaliaÃ§Ãµes Firebase: <span id="contador-firebase">carregando...</span></li>
        <li>Escolas processadas: <span id="contador-total">0</span></li>
      </ul>
      
      <button id="btn-atualizar-dados" class="btn-dados">
        ğŸ”„ Atualizar Dados Agora
      </button>
    </div>
    
    <div class="dados-coluna">
      <h4>ğŸ“ˆ MÃ©tricas InstantÃ¢neas</h4>
      <div id="metricas-instantaneas">
        <div class="metrica-instantanea">
          <div class="valor" id="metricas-criticas">0</div>
          <div class="label">Escolas CrÃ­ticas</div>
        </div>
        <div class="metrica-instantanea">
          <div class="valor" id="metricas-avaliadas">0%</div>
          <div class="label">Taxa de AvaliaÃ§Ã£o</div>
        </div>
        <div class="metrica-instantanea">
          <div class="valor" id="metricas-pontuacao">0</div>
          <div class="label">PontuaÃ§Ã£o MÃ©dia</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MAPA -->
<div id="mapa" class="secao ativa">
  <div class="painel">
    <div class="painel-superior">
      <label>
        Indicador:
        <select id="seletorIndicador">
          <option value="densidade-critica">ğŸ“ Densidade CrÃ­tica</option>
          <option value="concentracao-relativa">ğŸ“ˆ ConcentraÃ§Ã£o Relativa</option>
          <option value="zonas-prioritarias">ğŸŸ¥ Zonas PrioritÃ¡rias</option>
          <option value="kde">ğŸ”¥ KDE (Hotspots)</option>
          <option value="gini">âš–ï¸ Gini (Desigualdade)</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="toggleZonas" checked>
        ğŸŸ¥ Zonas prioritÃ¡rias
      </label>
      <label>
        <button id="btn-voronoi" style="margin-left: 10px; padding: 5px 10px; cursor: pointer;">
          ğŸ§© Gerar Voronoi
        </button>
      </label>
    </div>
    
    <div class="painel-inferior">
      <div id="status-mapa"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<!-- RANKING -->
<div id="ranking" class="secao">
  <h3>ğŸ“Š Ranking Territorial â€” Zonas PrioritÃ¡rias</h3>
  <div class="ranking-filtros">
    <label>
      Filtrar por:
      <select id="filtro-ranking">
        <option value="todas">Todas as Escolas</option>
        <option value="criticas">Apenas CrÃ­ticas</option>
        <option value="atencao">AtenÃ§Ã£o + CrÃ­ticas</option>
        <option value="avaliadas">Apenas Avaliadas</option>
      </select>
    </label>
    <button id="btn-exportar-ranking">ğŸ“¥ Exportar CSV</button>
  </div>
  <ol id="listaRanking"></ol>
</div>

<!-- METODOLOGIA -->
<div id="metodologia" class="secao">
  <h3>ğŸ“˜ Metodologia e Indicadores</h3>
  <div class="metodologia-content">
    <div class="metodologia-coluna">
      <h4>ğŸ“‹ Indicadores DisponÃ­veis:</h4>
      <ul>
        <li><strong>ğŸ“Š Pareto</strong>: Identifica os 20% de escolas que concentram 80% dos problemas</li>
        <li><strong>ğŸ“ Densidade CrÃ­tica</strong>: Mede a concentraÃ§Ã£o espacial de ocorrÃªncias</li>
        <li><strong>ğŸ“ˆ ConcentraÃ§Ã£o Relativa</strong>: Compara densidade local com mÃ©dia global</li>
        <li><strong>ğŸŸ¥ Zonas PrioritÃ¡rias</strong>: Ãreas com mÃºltiplas vulnerabilidades sobrepostas</li>
        <li><strong>ğŸ”¥ KDE (Kernel Density Estimation)</strong>: IdentificaÃ§Ã£o estatÃ­stica de hotspots</li>
        <li><strong>âš–ï¸ Coeficiente de Gini Espacial</strong>: Mede desigualdade na distribuiÃ§Ã£o espacial</li>
        <li><strong>ğŸ“ˆ Location Quotient (LQ)</strong>: Identifica especializaÃ§Ã£o regional</li>
        <li><strong>ğŸ”— Ãndice de Moran</strong>: Detecta autocorrelaÃ§Ã£o espacial (clusters)</li>
      </ul>
    </div>
    
    <div class="metodologia-coluna">
      <h4>ğŸ¯ Fontes de Dados:</h4>
      <ul>
        <li><strong>Dados Locais</strong>: Base oficial de escolas municipais de Fortaleza (mapa/escolas.js)</li>
        <li><strong>Firebase</strong>: AvaliaÃ§Ãµes em tempo real dos usuÃ¡rios (classe, pontuaÃ§Ã£o, timestamp)</li>
        <li><strong>IntegraÃ§Ã£o</strong>: CombinaÃ§Ã£o automÃ¡tica de mÃºltiplas fontes</li>
      </ul>
      
      <h4>ğŸ”§ Tecnologias Utilizadas:</h4>
      <ul>
        <li>Leaflet.js para visualizaÃ§Ã£o de mapas</li>
        <li>Firebase Firestore para banco de dados em tempo real</li>
        <li>JavaScript puro para anÃ¡lise espacial</li>
        <li>Algoritmos estatÃ­sticos para cÃ¡lculos avanÃ§ados</li>
      </ul>
    </div>
  </div>
  
  <div class="metodologia-aviso">
    <h4>âš ï¸ LimitaÃ§Ãµes e ConsideraÃ§Ãµes:</h4>
    <p>As anÃ¡lises sÃ£o <strong>exploratÃ³rias e indicativas</strong>, baseadas em dados disponÃ­veis. 
    NÃ£o substituem vistorias tÃ©cnicas presenciais nem diagnÃ³stico especializado. 
    Os resultados devem ser interpretados por profissionais qualificados.</p>
  </div>
</div>

<!-- ANÃLISE AVANÃ‡ADA -->
<div id="avancada" class="secao">
  <h3>ğŸš€ AnÃ¡lise AvanÃ§ada</h3>
  <div class="avancada-content">
    <div class="avancada-grid">
      <div class="avancada-card">
        <h4>ğŸ§© Diagrama de Voronoi</h4>
        <p>Particiona o territÃ³rio em Ã¡reas de influÃªncia para cada escola.</p>
        <button id="btn-analise-voronoi" class="btn-avancada">Gerar Voronoi</button>
        <div id="voronoi-container" class="avancada-output"></div>
      </div>
      
      <div class="avancada-card">
        <h4>ğŸ“ AnÃ¡lise de Impacto</h4>
        <p>Calcula raio de impacto baseado na severidade dos problemas.</p>
        <label>Raio de Impacto (metros): 
          <input type="range" id="raio-impacto" min="100" max="2000" value="500">
          <span id="raio-value">500m</span>
        </label>
        <button id="btn-calcular-impacto" class="btn-avancada">Calcular Impacto</button>
        <div id="impacto-container" class="avancada-output"></div>
      </div>
      
      <div class="avancada-card">
        <h4>ğŸ“ˆ EstatÃ­sticas AvanÃ§adas</h4>
        <p>MÃ©tricas estatÃ­sticas para tomada de decisÃ£o.</p>
        <div id="estatisticas-container" class="avancada-output">
          <p>Clique em "Calcular" para gerar estatÃ­sticas.</p>
        </div>
        <button id="btn-calcular-estatisticas" class="btn-avancada">Calcular EstatÃ­sticas</button>
      </div>
    </div>
    
    <div class="avancada-map">
      <h4>ğŸ—ºï¸ Mapa de AnÃ¡lise AvanÃ§ada</h4>
      <div id="mapa-avancado" style="height: 400px; border-radius: 8px; margin-top: 10px;"></div>
    </div>
  </div>
</div>

<footer>
  Â© 2026 CheckInfra â€” CÃ³digo MIT | ğŸ”’ LGPD conforme lei nÂº 13.709/2018
  <div style="font-size: 11px; margin-top: 5px; opacity: 0.8;">
    v2.0 | AnÃ¡lise Espacial com 8 indicadores integrados | Fortaleza/CE
  </div>
</footer>

<!-- Scripts Firebase -->
<!-- Use a versÃ£o COMPAT (global) do Firebase v9 -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script><!-- Dados locais - AJUSTE O CAMINHO CONFORME SUA ESTRUTURA -->
<script src="../mapa/escolas.js"></script>

<!-- ConfiguraÃ§Ã£o do Firebase (crie este arquivo na pasta anÃ¡lise-espacial) -->
<script src="firebase-config.js"></script>

<!-- Sistema de dados integrado (crie este arquivo na pasta anÃ¡lise-espacial) -->
<script src="dados.js"></script>

<!-- Bibliotecas para mapas -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- Bibliotecas para Voronoi e anÃ¡lise espacial -->
<script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>

<!-- Scripts principais -->
<script src="abas.js"></script>
<script src="recalculos.js"></script>
<script src="mapa.js"></script>
<script src="eventos.js"></script>
<script src="sidebar.js"></script>

<!-- Dashboard de dados -->
<script src="dashboard-dados.js"></script>

<!-- Scripts de anÃ¡lise avanÃ§ada -->
<script src="analise-avancada.js"></script>
<script src="voronoi-impacto.js"></script>
<script src="mapa-voronoi.js"></script>

<!-- ConfiguraÃ§Ã£o inicial -->
<script>
// Handler para botÃ£o voltar
document.getElementById('btn-voltar').addEventListener('click', function() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = '/';
  }
});

// Sistema de abas atualizado
function abrirAba(nome) {
  // Esconde todas as seÃ§Ãµes
  document.querySelectorAll('.secao').forEach(sec => {
    sec.classList.remove('ativa');
  });
  
  // Remove ativa de todos os botÃµes
  document.querySelectorAll('.abas button').forEach(btn => {
    btn.classList.remove('ativa');
  });
  
  // Mostra a seÃ§Ã£o correspondente
  const secao = document.getElementById(nome);
  if (secao) {
    secao.classList.add('ativa');
    
    // Ativa o botÃ£o correspondente
    const botao = Array.from(document.querySelectorAll('.abas button')).find(btn => {
      const texto = btn.textContent;
      return (nome === 'mapa' && texto.includes('ğŸ—ºï¸')) ||
             (nome === 'ranking' && texto.includes('ğŸ“Š')) ||
             (nome === 'metodologia' && texto.includes('ğŸ“˜')) ||
             (nome === 'avancada' && texto.includes('ğŸš€')) ||
             (nome === 'dados' && texto.includes('ğŸ“Š'));
    });
    
    if (botao) {
      botao.classList.add('ativa');
    }
    
    // AÃ§Ãµes especÃ­ficas para cada aba
    setTimeout(() => {
      // Mapa - redimensionar
      if (nome === 'mapa' && window.map) {
        window.map.invalidateSize();
      }
      
      // AnÃ¡lise avanÃ§ada - inicializar mapa avanÃ§ado
      if (nome === 'avancada' && typeof inicializarMapaAvancado === 'function') {
        inicializarMapaAvancado();
      }
      
      // Dados - atualizar dashboard
      if (nome === 'dados' && window.dashboardDados) {
        window.dashboardDados.atualizar();
      }
    }, 300);
  }
}

// InicializaÃ§Ã£o quando a pÃ¡gina carrega
document.addEventListener('DOMContentLoaded', function() {
  console.log('AnÃ¡lise Espacial v2.0 carregada');
  console.log('ğŸ“ Base de dados: Escolas municipais de Fortaleza');
  console.log('ğŸ“Š 8 indicadores disponÃ­veis:');
  console.log('   - Pareto, Densidade CrÃ­tica, ConcentraÃ§Ã£o Relativa, Zonas PrioritÃ¡rias');
  console.log('   - KDE, Gini Espacial, Location Quotient, Ãndice de Moran');
  
  // BotÃ£o para atualizar dados
  const btnAtualizar = document.getElementById('btn-atualizar-dados');
  if (btnAtualizar) {
    btnAtualizar.addEventListener('click', function() {
      if (window.dadosManager) {
        console.log('ğŸ”„ Atualizando dados manualmente...');
        window.dadosManager.inicializar();
        btnAtualizar.textContent = 'ğŸ”„ Atualizando...';
        btnAtualizar.disabled = true;
        
        setTimeout(() => {
          btnAtualizar.textContent = 'ğŸ”„ Atualizar Dados Agora';
          btnAtualizar.disabled = false;
        }, 3000);
      }
    });
  }
  
  // BotÃ£o para exportar ranking
  const btnExportar = document.getElementById('btn-exportar-ranking');
  if (btnExportar) {
    btnExportar.addEventListener('click', function() {
      exportarRankingCSV();
    });
  }
  
  // Atualizar status da conexÃ£o
  function atualizarStatusConexao() {
    const statusDiv = document.getElementById('conexao-status');
    if (!statusDiv) return;
    
    if (window.firebaseManager) {
      statusDiv.innerHTML = '<p style="color: #28a745;">âœ… Conectado ao Firebase</p>';
    } else {
      statusDiv.innerHTML = '<p style="color: #dc3545;">âš ï¸ Firebase nÃ£o configurado</p>';
    }
  }
  
  // Escutar eventos do sistema de dados
  if (window.dadosManager) {
    window.dadosManager.adicionarListener('dados_atualizados', function(dados) {
      console.log('ğŸ“Š Dados atualizados:', dados.escolas.length, 'escolas');
      
      // Atualizar contadores
      const escolasLocal = dados.escolas.filter(e => e.fonte === 'local').length;
      const escolasFirebase = dados.escolas.filter(e => e.fonte === 'firebase').length;
      const total = dados.escolas.length;
      
      document.getElementById('contador-local').textContent = escolasLocal;
      document.getElementById('contador-firebase').textContent = escolasFirebase;
      document.getElementById('contador-total').textContent = total;
      
      // Atualizar mÃ©tricas
      if (dados.metricas) {
        document.getElementById('metricas-criticas').textContent = dados.metricas.escolasCriticas || 0;
        document.getElementById('metricas-avaliadas').textContent = dados.metricas.percentualAvaliadas || '0%';
        document.getElementById('metricas-pontuacao').textContent = dados.metricas.pontuacaoMedia || '0';
      }
    });
    
    window.dadosManager.adicionarListener('status', function(status, erro) {
      const statusMapa = document.getElementById('status-mapa');
      if (statusMapa) {
        switch(status) {
          case 'inicializando':
            statusMapa.innerHTML = '<p>ğŸ”„ Carregando dados...</p>';
            break;
          case 'carregando':
            statusMapa.innerHTML = '<p>ğŸ“¡ Conectando ao Firebase...</p>';
            break;
          case 'pronto':
            statusMapa.innerHTML = '<p>âœ… Dados carregados!</p>';
            break;
          case 'erro':
            statusMapa.innerHTML = `<p>âŒ Erro: ${erro?.message || 'Desconhecido'}</p>`;
            break;
        }
      }
    });
  }
  
  // Inicializar status
  setTimeout(atualizarStatusConexao, 1000);
});

// FunÃ§Ã£o para exportar ranking como CSV
function exportarRankingCSV() {
  if (!window.dadosManager) {
    alert('Dados nÃ£o disponÃ­veis');
    return;
  }
  
  const escolas = window.dadosManager.getEscolas();
  if (!escolas || escolas.length === 0) {
    alert('Nenhuma escola para exportar');
    return;
  }
  
  // Ordenar por criticidade (peso)
  const escolasOrdenadas = [...escolas].sort((a, b) => b.peso - a.peso);
  
  // Criar cabeÃ§alho CSV
  let csv = 'Nome,Latitude,Longitude,Classe,PontuaÃ§Ã£o,AvaliaÃ§Ãµes,Fonte\n';
  
  // Adicionar dados
  escolasOrdenadas.forEach(escola => {
    csv += `"${escola.nome}",${escola.lat},${escola.lng},${escola.classe},${escola.pontuacao},${escola.avaliacoes?.length || 0},${escola.fonte}\n`;
  });
  
  // Criar blob e fazer download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `ranking-escolas-${new Date().toISOString().slice(0, 10)}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  console.log('ğŸ“¥ Ranking exportado como CSV');
}
</script>

</body>
</html>